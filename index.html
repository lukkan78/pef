<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#6366f1" id="themeColor">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="assets/icon-512.png">
  <title>PEF-dagbok</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #a5b4fc;
      --success: #10b981;
      --success-bg: #d1fae5;
      --warning: #f59e0b;
      --warning-bg: #fef3c7;
      --danger: #ef4444;
      --danger-bg: #fee2e2;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: white;
      --text-primary: var(--gray-800);
      --text-secondary: var(--gray-500);
      --border-color: var(--gray-200);
      --input-bg: white;
      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    }

    /* Dark Mode */
    [data-theme="dark"] {
      --gray-50: #1f2937;
      --gray-100: #374151;
      --gray-200: #4b5563;
      --gray-300: #6b7280;
      --gray-400: #9ca3af;
      --gray-500: #d1d5db;
      --gray-600: #e5e7eb;
      --gray-700: #f3f4f6;
      --gray-800: #f9fafb;
      --gray-900: #ffffff;
      --bg-gradient: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
      --card-bg: #1f2937;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --border-color: #374151;
      --input-bg: #374151;
      --success-bg: rgba(16, 185, 129, 0.2);
      --warning-bg: rgba(245, 158, 11, 0.2);
      --danger-bg: rgba(239, 68, 68, 0.2);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      color: var(--text-primary);
      padding-bottom: 100px;
      /* iOS safe areas f√∂r notch/Dynamic Island */
      padding-top: env(safe-area-inset-top);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      transition: background 0.3s;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 16px;
      padding-top: 130px; /* Plats f√∂r fixed header */
    }

    /* Header */
    header {
      text-align: center;
      padding: 16px 16px 12px;
      padding-top: calc(16px + env(safe-area-inset-top));
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 100;
      transition: background 0.3s;
    }

    [data-theme="dark"] header {
      background: linear-gradient(135deg, #1e1e2e 0%, #2d1b4e 100%);
    }

    header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .header-actions {
      position: absolute;
      top: calc(12px + env(safe-area-inset-top));
      right: 16px;
      display: flex;
      gap: 8px;
    }

    .theme-toggle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.3);
    }

    .theme-toggle svg {
      width: 20px;
      height: 20px;
      color: white;
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-lg);
      transition: background 0.3s;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title .icon {
      width: 20px;
      height: 20px;
      opacity: 0.7;
    }

    /* Input Section */
    .pef-input-wrapper {
      position: relative;
      margin-bottom: 16px;
    }

    .pef-input {
      width: 100%;
      font-size: 48px;
      font-weight: 700;
      text-align: center;
      border: 3px solid var(--border-color);
      border-radius: var(--radius);
      padding: 24px 16px;
      color: var(--text-primary);
      background: var(--input-bg);
      transition: all 0.2s;
      -moz-appearance: textfield;
    }

    .pef-input::-webkit-outer-spin-button,
    .pef-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .pef-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .pef-input::placeholder {
      color: var(--gray-400);
      font-size: 32px;
    }

    .input-suffix {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 16px;
      font-weight: 500;
    }

    /* Zone indicator */
    .zone-indicator {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .zone-bar {
      flex: 1;
      height: 8px;
      border-radius: 4px;
      background: var(--border-color);
      transition: all 0.3s;
    }

    .zone-bar.green { background: var(--success); }
    .zone-bar.yellow { background: var(--warning); }
    .zone-bar.red { background: var(--danger); }
    .zone-bar.inactive { opacity: 0.2; }

    .zone-text {
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
    }

    .zone-text.green { background: var(--success-bg); color: #10b981; }
    .zone-text.yellow { background: var(--warning-bg); color: #f59e0b; }
    .zone-text.red { background: var(--danger-bg); color: #ef4444; }
    .zone-text.neutral { background: var(--gray-100); color: var(--text-secondary); }

    [data-theme="dark"] .zone-text.green { color: #34d399; }
    [data-theme="dark"] .zone-text.yellow { color: #fbbf24; }
    [data-theme="dark"] .zone-text.red { color: #f87171; }

    /* Symptom Buttons */
    .symptom-section {
      margin-bottom: 16px;
    }

    .symptom-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .symptom-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .symptom-btn {
      flex: 1;
      min-width: calc(50% - 4px);
      padding: 10px 12px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .symptom-btn:hover {
      border-color: var(--primary);
    }

    .symptom-btn.active {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
    }

    .symptom-btn[data-symptom="frisk"].active {
      border-color: var(--success);
      background: var(--success-bg);
      color: var(--success);
    }

    .symptom-btn[data-symptom="forkyld"].active {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    .symptom-btn[data-symptom="hosta"].active {
      border-color: var(--warning);
      background: var(--warning-bg);
      color: var(--warning);
    }

    .symptom-btn[data-symptom="allergi"].active {
      border-color: #ec4899;
      background: rgba(236, 72, 153, 0.1);
      color: #ec4899;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      width: 100%;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 14px;
    }

    .btn-icon {
      width: 40px;
      height: 40px;
      padding: 0;
      border-radius: 50%;
      background: var(--gray-100);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: var(--gray-200);
    }

    .btn-icon svg {
      width: 20px;
      height: 20px;
      color: var(--text-secondary);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-box {
      background: var(--gray-50);
      padding: 16px;
      border-radius: var(--radius-sm);
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .stat-box.highlight {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    }

    .stat-box.highlight .stat-value,
    .stat-box.highlight .stat-label {
      color: white;
    }

    /* Chart */
    .chart-container {
      position: relative;
      height: 200px;
      margin: 16px 0;
    }

    /* History List */
    .history-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      gap: 12px;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-zone {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .history-zone.green { background: var(--success); }
    .history-zone.yellow { background: var(--warning); }
    .history-zone.red { background: var(--danger); }

    .history-content {
      flex: 1;
    }

    .history-value {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary);
    }

    .history-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .history-delete {
      opacity: 0.5;
      transition: opacity 0.2s;
    }

    .history-item:hover .history-delete {
      opacity: 1;
    }

    /* Touch devices - always show delete button */
    @media (hover: none) {
      .history-delete {
        opacity: 0.7;
      }
    }

    /* Variability details list */
    .variability-list {
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      padding: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .variability-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-color);
      font-size: 13px;
    }

    .variability-item:last-child {
      border-bottom: none;
    }

    .variability-date {
      color: var(--text-secondary);
    }

    .variability-values {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .variability-percent {
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .variability-percent.good {
      background: var(--success-bg);
      color: var(--success);
    }

    .variability-percent.moderate {
      background: var(--warning-bg);
      color: var(--warning);
    }

    .variability-percent.poor {
      background: var(--danger-bg);
      color: var(--danger);
    }

    .show-all-btn {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      background: var(--gray-100);
      border: none;
      border-radius: var(--radius-sm);
      color: var(--primary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .show-all-btn:hover {
      background: var(--gray-200);
    }

    /* Profile Form */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-family: inherit;
      transition: all 0.2s;
      background: var(--input-bg);
      color: var(--text-primary);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-input::placeholder {
      color: var(--text-secondary);
    }

    /* Sex selector */
    .sex-selector {
      display: flex;
      gap: 12px;
    }

    .sex-option {
      flex: 1;
      padding: 16px;
      text-align: center;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--input-bg);
      cursor: pointer;
      transition: all 0.2s;
    }

    .sex-option:hover {
      border-color: var(--primary-light);
    }

    .sex-option.active {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
    }

    .sex-option svg {
      width: 32px;
      height: 32px;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .sex-option.active svg {
      color: var(--primary);
    }

    .sex-option span {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 24px;
      width: 100%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s, background 0.3s;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--gray-800);
      color: white;
      padding: 12px 24px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s;
      box-shadow: var(--shadow-lg);
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }

    /* Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      z-index: 100;
      transition: background 0.3s, border-color 0.3s;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 16px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
      border: none;
      background: none;
      cursor: pointer;
      transition: color 0.2s;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-item svg {
      width: 24px;
      height: 24px;
      margin-bottom: 4px;
    }

    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 8px;
    }

    .export-buttons .btn {
      flex: 1;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Reference selector */
    .ref-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .ref-option {
      flex: 1;
      padding: 8px;
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .ref-option.active {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
    }

    /* Profile stats in header */
    .profile-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.2);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      margin-top: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .profile-badge:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .pulse {
      animation: pulse 0.3s ease-in-out;
    }

    /* Responsive */
    @media (max-width: 380px) {
      .pef-input {
        font-size: 40px;
      }
      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .stat-value {
        font-size: 20px;
      }
    }

    /* AI Insights */
    .insights-card {
      margin-top: 16px;
    }

    .insight-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      align-items: flex-start;
    }

    .insight-item:last-child {
      margin-bottom: 0;
    }

    .insight-icon {
      font-size: 20px;
      flex-shrink: 0;
      width: 28px;
      text-align: center;
    }

    .insight-content {
      flex: 1;
    }

    .insight-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .insight-text {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .insight-item.warning {
      background: var(--warning-bg);
      border-left: 3px solid var(--warning);
    }

    .insight-item.danger {
      background: var(--danger-bg);
      border-left: 3px solid var(--danger);
    }

    .insight-item.success {
      background: var(--success-bg);
      border-left: 3px solid var(--success);
    }

    .insight-item.info {
      background: rgba(99, 102, 241, 0.1);
      border-left: 3px solid var(--primary);
    }

    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }

    .prediction-box {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
      border: 1px solid var(--primary-light);
      border-radius: var(--radius-sm);
      padding: 16px;
      margin-top: 12px;
      text-align: center;
    }

    .prediction-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .prediction-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
    }

    .prediction-confidence {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .ai-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .ai-loading .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .trend-indicator.up {
      background: var(--success-bg);
      color: var(--success);
    }

    .trend-indicator.down {
      background: var(--danger-bg);
      color: var(--danger);
    }

    .trend-indicator.stable {
      background: var(--gray-100);
      color: var(--text-secondary);
    }

    /* Install prompt */
    .install-banner {
      background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
      color: white;
      padding: 16px;
      border-radius: var(--radius);
      margin-bottom: 16px;
      display: none;
    }

    .install-banner.show {
      display: block;
    }

    .install-banner h3 {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .install-banner p {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 12px;
    }

    .install-banner .btn {
      background: white;
      color: var(--primary-dark);
    }

    /* Predicted display box */
    .predicted-box {
      background: var(--gray-50);
      padding: 16px;
      border-radius: var(--radius-sm);
      margin-top: 8px;
    }

    .predicted-box .label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .predicted-box .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    /* Medication section */
    .medication-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .section-subtitle {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
    }

    .medication-history {
      margin-top: 12px;
    }

    .med-history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      font-size: 13px;
    }

    .med-history-item .med-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    .med-history-item .med-date {
      color: var(--text-secondary);
    }

    .med-history-item .med-current {
      background: var(--success-bg);
      color: var(--success);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
    }

    /* Profile info display */
    .profile-info {
      background: var(--gray-50);
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .profile-info .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: 600;
    }

    .profile-info .details {
      flex: 1;
    }

    .profile-info .name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .profile-info .meta {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Footer */
    .app-footer {
      text-align: center;
      padding: 24px 16px 16px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 12px;
    }

    .app-footer .version {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .app-footer .copyright {
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-actions">
      <button class="theme-toggle" onclick="toggleTheme()" title="V√§xla m√∂rkt/ljust l√§ge">
        <svg id="themeIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
        </svg>
      </button>
    </div>
    <h1>PEF-dagbok</h1>
    <p>Sp√•ra din lungfunktion</p>
    <div class="profile-badge" onclick="showProfileModal()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
      </svg>
      <span id="profileBadgeText">Ange profil</span>
    </div>
  </header>

  <div class="container">
    <!-- Install Banner -->
    <div class="install-banner" id="installBanner">
      <h3>Installera appen</h3>
      <p>L√§gg till PEF-dagbok p√• din hemsk√§rm f√∂r snabb √•tkomst och offline-anv√§ndning.</p>
      <button class="btn" onclick="installApp()">Installera</button>
    </div>

    <!-- Update Banner -->
    <div class="install-banner" id="updateBanner" style="background: linear-gradient(135deg, #2563eb, #1d4ed8);">
      <h3>üîÑ Ny version tillg√§nglig!</h3>
      <p>En uppdatering finns tillg√§nglig med nya funktioner och f√∂rb√§ttringar.</p>
      <button class="btn" onclick="applyUpdate()" style="background: white; color: #2563eb;">Uppdatera nu</button>
    </div>

    <!-- Main Sections (controlled by nav) -->
    <main id="mainContent">
      <!-- Logga Section -->
      <section id="sectionLog" class="section active">
        <div class="card">
          <div class="card-header">
            <span class="card-title">
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
              Ny m√§tning
            </span>
          </div>

          <div class="pef-input-wrapper">
            <input type="number" id="pefInput" class="pef-input" placeholder="---" inputmode="numeric" autocomplete="off">
            <span class="input-suffix">L/min</span>
          </div>

          <div class="zone-indicator">
            <div class="zone-bar green inactive" id="zoneGreen"></div>
            <div class="zone-bar yellow inactive" id="zoneYellow"></div>
            <div class="zone-bar red inactive" id="zoneRed"></div>
          </div>

          <div class="zone-text neutral" id="zoneText">Ange ditt PEF-v√§rde</div>

          <div class="symptom-section">
            <label class="symptom-label">Hur m√•r du?</label>
            <div class="symptom-buttons">
              <button type="button" class="symptom-btn active" data-symptom="frisk" onclick="selectSymptom('frisk')">
                ‚úì Frisk
              </button>
              <button type="button" class="symptom-btn" data-symptom="forkyld" onclick="selectSymptom('forkyld')">
                ü§ß F√∂rkyld
              </button>
              <button type="button" class="symptom-btn" data-symptom="hosta" onclick="selectSymptom('hosta')">
                üò∑ Hosta
              </button>
              <button type="button" class="symptom-btn" data-symptom="allergi" onclick="selectSymptom('allergi')">
                üå∏ Allergi
              </button>
            </div>
          </div>

          <button class="btn btn-primary" id="saveBtn" onclick="saveMeasurement()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Spara m√§tning
          </button>
        </div>

        <!-- Quick Stats -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Idag</span>
          </div>
          <div class="stats-grid">
            <div class="stat-box highlight">
              <div class="stat-value" id="todayBest">--</div>
              <div class="stat-label">B√§sta idag</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="todayCount">0</div>
              <div class="stat-label">M√§tningar</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="personalBest">--</div>
              <div class="stat-label">Personb√§sta</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="predictedValue">--</div>
              <div class="stat-label">F√∂rv√§ntat</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Statistik Section -->
      <section id="sectionStats" class="section" style="display:none">
        <div class="card">
          <div class="card-header">
            <span class="card-title">
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
              </svg>
              Utveckling
            </span>
          </div>

          <div class="ref-selector">
            <button class="ref-option active" data-ref="personal" onclick="setRefMode('personal')">% av personb√§sta</button>
            <button class="ref-option" data-ref="predicted" onclick="setRefMode('predicted')">% av f√∂rv√§ntat</button>
          </div>

          <div class="chart-container">
            <canvas id="pefChart"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Sammanfattning (30 dagar)</span>
          </div>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-value" id="stat30Best">--</div>
              <div class="stat-label">B√§sta</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="stat30Avg">--</div>
              <div class="stat-label">Medel</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="stat30Low">--</div>
              <div class="stat-label">L√§gsta</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="stat30Count">0</div>
              <div class="stat-label">M√§tningar</div>
            </div>
          </div>

          <div class="stats-grid" style="margin-top: 12px;">
            <div class="stat-box">
              <div class="stat-value" id="statGreen" style="color: var(--success);">0%</div>
              <div class="stat-label">Gr√∂n zon</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="statYellow" style="color: var(--warning);">0%</div>
              <div class="stat-label">Gul zon</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="statAvgPctPredicted">--%</div>
              <div class="stat-label">% av f√∂rv√§ntat</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="statAvgPctBest">--%</div>
              <div class="stat-label">% av personb√§sta</div>
            </div>
          </div>

          <div class="stats-grid" style="margin-top: 8px;">
            <div class="stat-box">
              <div class="stat-value" id="statLowPct">--%</div>
              <div class="stat-label">L√§gsta %</div>
            </div>
            <div class="stat-box" style="cursor: pointer;" onclick="toggleVariabilityDetails()">
              <div class="stat-value" id="statVariability">--%</div>
              <div class="stat-label">Variabilitet <span style="font-size: 10px; opacity: 0.7;">(detaljer)</span></div>
            </div>
          </div>
          <div id="variabilityDetails" style="display: none; margin-top: 8px;">
            <div class="variability-list" id="variabilityList"></div>
          </div>
        </div>

        <!-- AI Insights Card -->
        <div class="card insights-card">
          <div class="card-header">
            <span class="card-title">
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
              </svg>
              Insikter
              <span class="ai-badge" id="aiBadge" style="display:none;">AI</span>
            </span>
          </div>
          <div id="insightsContainer">
            <div class="empty-state" style="padding: 20px;">
              <p>Logga m√§tningar f√∂r att f√• insikter</p>
            </div>
          </div>
          <div id="predictionContainer" style="display:none;">
            <div class="prediction-box">
              <div class="prediction-label">AI-prediktion f√∂r imorgon</div>
              <div class="prediction-value" id="predictionValue">--</div>
              <div class="prediction-confidence" id="predictionConfidence"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Historik Section -->
      <section id="sectionHistory" class="section" style="display:none">
        <div class="card">
          <div class="card-header">
            <span class="card-title">
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Historik
            </span>
            <button class="btn btn-secondary btn-sm" onclick="clearAllData()">Rensa allt</button>
          </div>

          <div class="history-list" id="historyList">
            <div class="empty-state">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              <p>Inga m√§tningar √§nnu</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Exportera data</span>
          </div>
          <div class="export-buttons">
            <button class="btn btn-secondary" onclick="exportCSV()">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              CSV
            </button>
            <button class="btn btn-primary" onclick="exportPDF()">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
              </svg>
              PDF-rapport
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Backup</span>
          </div>
          <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">
            S√§kerhetskopiera alla m√§tv√§rden och inst√§llningar till en JSON-fil som du kan √•terst√§lla senare.
          </p>
          <div class="export-buttons">
            <button class="btn btn-secondary" onclick="exportBackup()">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
              </svg>
              Exportera backup
            </button>
            <button class="btn btn-primary" onclick="document.getElementById('importBackupInput').click()">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
              Importera backup
            </button>
            <input type="file" id="importBackupInput" accept=".json" style="display: none;" onchange="importBackup(event)">
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="app-footer">
      <div class="version">PEF-dagbok v1.0</div>
      <div class="copyright">¬© 2026 Lukas Carnerheim</div>
    </footer>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-section="sectionLog" onclick="showSection('sectionLog')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
      </svg>
      Logga
    </button>
    <button class="nav-item" data-section="sectionStats" onclick="showSection('sectionStats')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
      </svg>
      Statistik
    </button>
    <button class="nav-item" data-section="sectionHistory" onclick="showSection('sectionHistory')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      Historik
    </button>
  </nav>

  <!-- Profile Modal -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Din profil</h2>
        <button class="btn-icon" onclick="hideProfileModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <div class="form-group">
        <label class="form-label">Namn</label>
        <input type="text" id="profileName" class="form-input" placeholder="Ditt namn">
      </div>

      <div class="form-group">
        <label class="form-label">K√∂n</label>
        <div class="sex-selector">
          <div class="sex-option" data-sex="male" onclick="selectSex('male')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="10" cy="14" r="5" stroke-width="2"/>
              <path stroke-linecap="round" stroke-width="2" d="M14 10l5-5m0 0v4m0-4h-4"/>
            </svg>
            <span>Man</span>
          </div>
          <div class="sex-option" data-sex="female" onclick="selectSex('female')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="9" r="5" stroke-width="2"/>
              <path stroke-linecap="round" stroke-width="2" d="M12 14v7m-3-3h6"/>
            </svg>
            <span>Kvinna</span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">F√∂delsedatum</label>
        <div class="form-row">
          <div class="form-group">
            <select id="profileBirthYear" class="form-select">
              <option value="">√Ör</option>
            </select>
          </div>
          <div class="form-group">
            <select id="profileBirthMonth" class="form-select">
              <option value="">M√•nad</option>
              <option value="1">Januari</option>
              <option value="2">Februari</option>
              <option value="3">Mars</option>
              <option value="4">April</option>
              <option value="5">Maj</option>
              <option value="6">Juni</option>
              <option value="7">Juli</option>
              <option value="8">Augusti</option>
              <option value="9">September</option>
              <option value="10">Oktober</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">L√§ngd (cm)</label>
        <input type="number" id="profileHeight" class="form-input" placeholder="t.ex. 175" min="100" max="220">
      </div>

      <div class="form-group">
        <label class="form-label">Referensalgoritm</label>
        <select id="profileAlgorithm" class="form-select">
          <option value="eu">EU-skala (standard i Sverige)</option>
          <option value="nunn">Nunn & Gregg (1989)</option>
        </select>
      </div>

      <div class="predicted-box">
        <div class="label">F√∂rv√§ntat PEF-v√§rde</div>
        <div class="value" id="predictedDisplay">-- L/min</div>
      </div>

      <div class="medication-section">
        <h3 class="section-subtitle">Medicinering</h3>

        <div class="form-group">
          <label class="form-label">Inhalator</label>
          <select id="profileInhaler" class="form-select">
            <option value="">V√§lj inhalator...</option>
            <optgroup label="Kombinationspreparat">
              <option value="symbicort">Symbicort (budesonid/formoterol)</option>
              <option value="innovair">Innovair (beklometason/formoterol)</option>
              <option value="seretide">Seretide (flutikason/salmeterol)</option>
              <option value="bufomix">Bufomix (budesonid/formoterol)</option>
              <option value="relvar">Relvar (flutikason/vilanterol)</option>
              <option value="duoresp">DuoResp (budesonid/formoterol)</option>
            </optgroup>
            <optgroup label="Kortikosteroider">
              <option value="pulmicort">Pulmicort (budesonid)</option>
              <option value="flutide">Flutide (flutikason)</option>
              <option value="giona">Giona (beklometason)</option>
            </optgroup>
            <optgroup label="Luftr√∂rsvidgande">
              <option value="ventoline">Ventoline (salbutamol)</option>
              <option value="bricanyl">Bricanyl (terbutalin)</option>
              <option value="atrovent">Atrovent (ipratropium)</option>
              <option value="spiriva">Spiriva (tiotropium)</option>
            </optgroup>
            <option value="other">Annan...</option>
          </select>
        </div>

        <div class="form-group" id="customInhalerGroup" style="display: none;">
          <label class="form-label">Ange inhalator</label>
          <input type="text" id="profileInhalerCustom" class="form-input" placeholder="T.ex. Airflusal">
        </div>

        <div class="form-group">
          <label class="form-label">Styrka</label>
          <select id="profileInhalerStrength" class="form-select">
            <option value="">V√§lj styrka...</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Startdatum</label>
          <input type="date" id="profileMedStartDate" class="form-input" style="max-width: 180px;">
        </div>

        <div id="medicationHistory" class="medication-history"></div>
      </div>

      <button class="btn btn-primary" onclick="saveProfile()" style="margin-top: 16px;">Spara profil</button>
    </div>
  </div>

  <!-- Edit Symptom Modal -->
  <div class="modal-overlay" id="editSymptomModal">
    <div class="modal" style="max-width: 340px;">
      <div class="modal-header">
        <h2 class="modal-title">√Ñndra status</h2>
        <button class="btn-icon" onclick="hideEditSymptomModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <p id="editSymptomInfo" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;"></p>
      <div class="symptom-buttons" id="editSymptomButtons">
        <button type="button" class="symptom-btn" data-symptom="frisk" onclick="saveEditedSymptom('frisk')">
          ‚úì Frisk
        </button>
        <button type="button" class="symptom-btn" data-symptom="forkyld" onclick="saveEditedSymptom('forkyld')">
          ü§ß F√∂rkyld
        </button>
        <button type="button" class="symptom-btn" data-symptom="hosta" onclick="saveEditedSymptom('hosta')">
          üò∑ Hosta
        </button>
        <button type="button" class="symptom-btn" data-symptom="allergi" onclick="saveEditedSymptom('allergi')">
          üå∏ Allergi
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ============================================
    // Data Management
    // ============================================

    let measurements = [];
    let profile = {
      name: '',
      sex: 'male',
      birthYear: null,
      birthMonth: null,
      heightCm: null,
      algorithm: 'eu',
      predicted: null,
      personalBest: null,
      currentMedication: null,
      medicationHistory: []
    };
    let chart = null;
    let refMode = 'personal';
    let deferredPrompt = null;
    let darkMode = false;
    let showAllHistory = false;
    let selectedSymptom = 'frisk';

    function selectSymptom(symptom) {
      selectedSymptom = symptom;
      document.querySelectorAll('.symptom-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.symptom === symptom);
      });
    }

    function getSymptomEmoji(symptom) {
      const emojis = {
        'frisk': '',
        'forkyld': 'ü§ß',
        'hosta': 'üò∑',
        'allergi': 'üå∏'
      };
      return emojis[symptom] || '';
    }

    function getMostCommonSymptom(measurements) {
      const counts = {};
      measurements.forEach(m => {
        if (m.symptom && m.symptom !== 'frisk') {
          counts[m.symptom] = (counts[m.symptom] || 0) + 1;
        }
      });
      let maxSymptom = null;
      let maxCount = 0;
      for (const [symptom, count] of Object.entries(counts)) {
        if (count > maxCount) {
          maxCount = count;
          maxSymptom = symptom;
        }
      }
      return maxSymptom;
    }

    function loadData() {
      const savedMeas = localStorage.getItem('pef_measurements');
      const savedProfile = localStorage.getItem('pef_profile');
      const savedTheme = localStorage.getItem('pef_theme');

      if (savedMeas) {
        measurements = JSON.parse(savedMeas);
      }

      if (savedProfile) {
        profile = { ...profile, ...JSON.parse(savedProfile) };
      }

      if (savedTheme === 'dark') {
        darkMode = true;
        document.documentElement.setAttribute('data-theme', 'dark');
        updateThemeIcon();
      }

      // Calculate personal best
      if (measurements.length > 0) {
        profile.personalBest = Math.max(...measurements.map(m => m.pef));
      }

      // Calculate predicted if we have profile data
      if (profile.birthYear && profile.heightCm) {
        profile.predicted = calculatePredictedPEF();
      }

      // Populate birth year dropdown
      populateBirthYears();
    }

    function saveData() {
      localStorage.setItem('pef_measurements', JSON.stringify(measurements));
      localStorage.setItem('pef_profile', JSON.stringify(profile));
    }

    function populateBirthYears() {
      const select = document.getElementById('profileBirthYear');
      const currentYear = new Date().getFullYear();
      for (let year = currentYear - 5; year >= currentYear - 100; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        select.appendChild(option);
      }
    }

    // ============================================
    // Theme Toggle
    // ============================================

    function toggleTheme() {
      darkMode = !darkMode;
      if (darkMode) {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('pef_theme', 'dark');
      } else {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('pef_theme', 'light');
      }
      updateThemeIcon();

      // Update chart colors
      if (chart) {
        updateChart();
      }
    }

    function updateThemeIcon() {
      const icon = document.getElementById('themeIcon');
      if (darkMode) {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
      } else {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>';
      }
    }

    // ============================================
    // PEF Prediction (EU Table)
    // ============================================

    const EU_TABLE = {
      female: {
        ages: [20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85],
        heights: [145, 150, 155, 160, 165, 170, 175, 180],
        values: [
          [438, 450, 461, 473, 485, 497, 509, 521],
          [431, 443, 455, 467, 479, 491, 503, 515],
          [423, 435, 447, 459, 471, 483, 495, 507],
          [413, 425, 437, 449, 461, 473, 485, 497],
          [402, 414, 426, 438, 450, 462, 474, 486],
          [390, 402, 414, 426, 438, 450, 462, 474],
          [376, 388, 400, 412, 424, 436, 448, 460],
          [361, 373, 385, 397, 409, 421, 433, 445],
          [345, 357, 369, 381, 393, 405, 417, 429],
          [327, 339, 351, 363, 375, 387, 399, 411],
          [308, 320, 332, 344, 356, 368, 380, 392],
          [288, 300, 312, 324, 336, 348, 360, 372],
          [266, 278, 290, 302, 314, 326, 338, 350],
          [243, 255, 267, 279, 291, 303, 315, 327]
        ]
      },
      male: {
        ages: [20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85],
        heights: [160, 165, 170, 175, 180, 185, 190, 195],
        values: [
          [554, 575, 596, 617, 638, 659, 680, 701],
          [556, 577, 598, 619, 640, 661, 682, 703],
          [556, 577, 598, 619, 640, 661, 682, 703],
          [552, 573, 594, 615, 636, 657, 678, 699],
          [545, 566, 587, 608, 629, 650, 671, 692],
          [535, 556, 577, 598, 619, 640, 661, 682],
          [521, 542, 563, 584, 605, 626, 647, 668],
          [504, 525, 546, 567, 588, 609, 630, 651],
          [484, 505, 526, 547, 568, 589, 610, 631],
          [461, 482, 503, 524, 545, 566, 587, 608],
          [434, 455, 476, 497, 518, 539, 560, 581],
          [404, 425, 446, 467, 488, 509, 530, 551],
          [371, 392, 413, 434, 455, 476, 497, 518],
          [335, 356, 377, 398, 419, 440, 461, 482]
        ]
      }
    };

    function interpolate(x, x0, x1, y0, y1) {
      if (x1 === x0) return y0;
      return y0 + (x - x0) * (y1 - y0) / (x1 - x0);
    }

    function calculateAge(birthYear, birthMonth) {
      const now = new Date();
      let age = now.getFullYear() - birthYear;
      if (birthMonth && now.getMonth() + 1 < birthMonth) {
        age--;
      }
      return age;
    }

    function calculatePredictedPEF(tempProfile = null) {
      const p = tempProfile || profile;
      if (!p.birthYear || !p.heightCm || !p.sex) return null;

      const age = calculateAge(p.birthYear, p.birthMonth);
      const heightCm = p.heightCm;
      const algorithm = p.algorithm || 'eu';

      // Use Nunn & Gregg if selected
      if (algorithm === 'nunn') {
        return calculateNunnGregg(p.sex, age, heightCm);
      }

      // Default: EU Table with bilinear interpolation
      return calculateEUTable(p.sex, age, heightCm);
    }

    // Nunn & Gregg (1989) formula
    // Original formulas in L/s, multiply by 60 for L/min
    function calculateNunnGregg(sex, age, heightCm) {
      const heightM = heightCm / 100; // Convert to meters

      let pef;
      if (sex === 'female') {
        // Women: PEF (L/s) = 5.50√óH - 0.030√óA - 1.11
        pef = (5.50 * heightM - 0.030 * age - 1.11) * 60;
      } else {
        // Men: PEF (L/s) = 6.14√óH - 0.043√óA + 0.15
        pef = (6.14 * heightM - 0.043 * age + 0.15) * 60;
      }

      return Math.round(Math.max(pef, 100)); // Minimum 100 L/min
    }

    // EU Table calculation with bilinear interpolation
    function calculateEUTable(sex, age, heightCm) {
      const table = EU_TABLE[sex];
      if (!table) return null;

      // Clamp values to table range
      const clampedAge = Math.max(table.ages[0], Math.min(table.ages[table.ages.length - 1], age));
      const clampedHeight = Math.max(table.heights[0], Math.min(table.heights[table.heights.length - 1], heightCm));

      // Find surrounding indices for age
      let ageIdx0 = 0, ageIdx1 = 0;
      for (let i = 0; i < table.ages.length - 1; i++) {
        if (clampedAge >= table.ages[i] && clampedAge <= table.ages[i + 1]) {
          ageIdx0 = i;
          ageIdx1 = i + 1;
          break;
        }
      }
      if (clampedAge >= table.ages[table.ages.length - 1]) {
        ageIdx0 = ageIdx1 = table.ages.length - 1;
      }

      // Find surrounding indices for height
      let hIdx0 = 0, hIdx1 = 0;
      for (let i = 0; i < table.heights.length - 1; i++) {
        if (clampedHeight >= table.heights[i] && clampedHeight <= table.heights[i + 1]) {
          hIdx0 = i;
          hIdx1 = i + 1;
          break;
        }
      }
      if (clampedHeight >= table.heights[table.heights.length - 1]) {
        hIdx0 = hIdx1 = table.heights.length - 1;
      }

      // Bilinear interpolation
      const v00 = table.values[ageIdx0][hIdx0];
      const v01 = table.values[ageIdx0][hIdx1];
      const v10 = table.values[ageIdx1][hIdx0];
      const v11 = table.values[ageIdx1][hIdx1];

      const vTop = interpolate(clampedHeight, table.heights[hIdx0], table.heights[hIdx1], v00, v01);
      const vBottom = interpolate(clampedHeight, table.heights[hIdx0], table.heights[hIdx1], v10, v11);
      const result = interpolate(clampedAge, table.ages[ageIdx0], table.ages[ageIdx1], vTop, vBottom);

      return Math.round(result);
    }

    // ============================================
    // Zone Calculation
    // ============================================

    function getZone(pef) {
      const reference = refMode === 'predicted' && profile.predicted
        ? profile.predicted
        : (profile.personalBest || profile.predicted || 500);

      const percentage = (pef / reference) * 100;

      if (percentage >= 80) return 'green';
      if (percentage >= 50) return 'yellow';
      return 'red';
    }

    function getZoneText(zone) {
      switch(zone) {
        case 'green': return 'Gr√∂n zon - Bra kontroll';
        case 'yellow': return 'Gul zon - Var uppm√§rksam';
        case 'red': return 'R√∂d zon - Agera nu';
        default: return 'Ange ditt PEF-v√§rde';
      }
    }

    function updateZoneIndicator(pef) {
      const zoneGreen = document.getElementById('zoneGreen');
      const zoneYellow = document.getElementById('zoneYellow');
      const zoneRed = document.getElementById('zoneRed');
      const zoneText = document.getElementById('zoneText');

      if (!pef || pef < 60) {
        zoneGreen.classList.add('inactive');
        zoneYellow.classList.add('inactive');
        zoneRed.classList.add('inactive');
        zoneText.className = 'zone-text neutral';
        zoneText.textContent = 'Ange ditt PEF-v√§rde';
        return;
      }

      const zone = getZone(pef);

      zoneGreen.classList.toggle('inactive', zone !== 'green');
      zoneYellow.classList.toggle('inactive', zone !== 'yellow');
      zoneRed.classList.toggle('inactive', zone !== 'red');

      zoneText.className = `zone-text ${zone}`;
      zoneText.textContent = getZoneText(zone);
    }

    // ============================================
    // Measurements
    // ============================================

    function saveMeasurement() {
      const input = document.getElementById('pefInput');
      const value = parseInt(input.value);

      if (!value || value < 60 || value > 900) {
        showToast('Ange ett v√§rde mellan 60-900 L/min', 'error');
        return;
      }

      const zone = getZone(value);
      const measurement = {
        id: Date.now(),
        ts: Date.now(),
        pef: value,
        zone: zone,
        symptom: selectedSymptom
      };

      measurements.push(measurement);

      // Update personal best
      if (value > (profile.personalBest || 0)) {
        profile.personalBest = value;
      }

      saveData();
      input.value = '';
      updateZoneIndicator(null);

      // Reset symptom to "frisk"
      selectSymptom('frisk');

      updateUI();
      showToast('M√§tning sparad!', 'success');

      // Animate button
      document.getElementById('saveBtn').classList.add('pulse');
      setTimeout(() => document.getElementById('saveBtn').classList.remove('pulse'), 300);
    }

    function toggleHistoryView() {
      showAllHistory = !showAllHistory;
      updateHistoryList();
    }

    function deleteMeasurement(id) {
      if (!confirm('Ta bort denna m√§tning?')) return;

      measurements = measurements.filter(m => m.id !== id);

      // Recalculate personal best
      profile.personalBest = measurements.length > 0
        ? Math.max(...measurements.map(m => m.pef))
        : null;

      saveData();
      updateUI();
      showToast('M√§tning borttagen');
    }

    let editingMeasurementId = null;

    function editMeasurementSymptom(id) {
      const measurement = measurements.find(m => m.id === id);
      if (!measurement) return;

      editingMeasurementId = id;

      const date = new Date(measurement.ts);
      const dateStr = date.toLocaleDateString('sv-SE');
      const timeStr = date.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });

      document.getElementById('editSymptomInfo').textContent =
        `${measurement.pef} L/min - ${dateStr} kl ${timeStr}`;

      // Mark current symptom as active
      document.querySelectorAll('#editSymptomButtons .symptom-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.symptom === (measurement.symptom || 'frisk'));
      });

      document.getElementById('editSymptomModal').classList.add('active');
    }

    function hideEditSymptomModal() {
      document.getElementById('editSymptomModal').classList.remove('active');
      editingMeasurementId = null;
    }

    function saveEditedSymptom(symptom) {
      if (!editingMeasurementId) return;

      const measurement = measurements.find(m => m.id === editingMeasurementId);
      if (measurement) {
        measurement.symptom = symptom;
        saveData();
        updateUI();
        showToast('Status uppdaterad!', 'success');
      }

      hideEditSymptomModal();
    }

    function clearAllData() {
      if (!confirm('√Ñr du s√§ker p√• att du vill radera ALL data? Detta kan inte √•ngras.')) return;

      measurements = [];
      profile.personalBest = null;
      saveData();
      updateUI();
      showToast('All data raderad');
    }

    // ============================================
    // UI Updates
    // ============================================

    function updateUI() {
      updateQuickStats();
      updateHistoryList();
      updateStatistics();
      updateChart();
      updateProfileBadge();
      updateInsights();
    }

    function updateQuickStats() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const todayMeasurements = measurements.filter(m => {
        const d = new Date(m.ts);
        d.setHours(0, 0, 0, 0);
        return d.getTime() === today.getTime();
      });

      document.getElementById('todayBest').textContent =
        todayMeasurements.length > 0
          ? Math.max(...todayMeasurements.map(m => m.pef))
          : '--';

      document.getElementById('todayCount').textContent = todayMeasurements.length;
      document.getElementById('personalBest').textContent = profile.personalBest || '--';
      document.getElementById('predictedValue').textContent = profile.predicted || '--';
    }

    function updateHistoryList() {
      const list = document.getElementById('historyList');

      if (measurements.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <p>Inga m√§tningar √§nnu</p>
          </div>
        `;
        return;
      }

      // Sort by newest first
      const sorted = [...measurements].sort((a, b) => b.ts - a.ts);
      const displayLimit = showAllHistory ? 50 : 3;
      const displayList = sorted.slice(0, displayLimit);
      const hasMore = sorted.length > 3;

      let html = displayList.map(m => {
        const date = new Date(m.ts);
        const dateStr = date.toLocaleDateString('sv-SE');
        const timeStr = date.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
        const symptomEmoji = getSymptomEmoji(m.symptom);

        return `
          <div class="history-item">
            <div class="history-zone ${m.zone}"></div>
            <div class="history-content" onclick="editMeasurementSymptom(${m.id})" style="cursor: pointer;">
              <div class="history-value">${m.pef} L/min ${symptomEmoji || '<span style="opacity:0.4">‚úé</span>'}</div>
              <div class="history-time">${dateStr} kl ${timeStr}</div>
            </div>
            <button class="btn-icon history-delete" onclick="deleteMeasurement(${m.id})" title="Ta bort">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        `;
      }).join('');

      // Add "Show more" / "Show less" button if there are more than 3
      if (hasMore) {
        if (showAllHistory) {
          html += `<button class="show-all-btn" onclick="toggleHistoryView()">Visa f√§rre</button>`;
        } else {
          html += `<button class="show-all-btn" onclick="toggleHistoryView()">Visa alla (${sorted.length} m√§tningar)</button>`;
        }
      }

      list.innerHTML = html;
    }

    function updateStatistics() {
      const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
      const recent = measurements.filter(m => m.ts >= thirtyDaysAgo);

      if (recent.length === 0) {
        document.getElementById('stat30Best').textContent = '--';
        document.getElementById('stat30Avg').textContent = '--';
        document.getElementById('stat30Low').textContent = '--';
        document.getElementById('stat30Count').textContent = '0';
        document.getElementById('statGreen').textContent = '0%';
        document.getElementById('statYellow').textContent = '0%';
        document.getElementById('statAvgPctPredicted').textContent = '--%';
        document.getElementById('statAvgPctBest').textContent = '--%';
        document.getElementById('statLowPct').textContent = '--%';
        document.getElementById('statVariability').textContent = '--%';
        return;
      }

      const values = recent.map(m => m.pef);
      const best = Math.max(...values);
      const low = Math.min(...values);
      const avg = Math.round(values.reduce((a, b) => a + b, 0) / values.length);

      document.getElementById('stat30Best').textContent = best;
      document.getElementById('stat30Avg').textContent = avg;
      document.getElementById('stat30Low').textContent = low;
      document.getElementById('stat30Count').textContent = recent.length;

      // Zone distribution
      const greenCount = recent.filter(m => m.zone === 'green').length;
      const yellowCount = recent.filter(m => m.zone === 'yellow').length;

      document.getElementById('statGreen').textContent = Math.round(100 * greenCount / recent.length) + '%';
      document.getElementById('statYellow').textContent = Math.round(100 * yellowCount / recent.length) + '%';

      // Procent-statistik
      const reference = profile.predicted || profile.personalBest;
      if (reference && reference > 0) {
        const avgPctPredicted = Math.round((avg / reference) * 100);
        const lowPctPredicted = Math.round((low / reference) * 100);
        document.getElementById('statAvgPctPredicted').textContent = avgPctPredicted + '%';
        document.getElementById('statLowPct').textContent = lowPctPredicted + '%';
      } else {
        document.getElementById('statAvgPctPredicted').textContent = '--%';
        document.getElementById('statLowPct').textContent = '--%';
      }

      if (profile.personalBest && profile.personalBest > 0) {
        const avgPctBest = Math.round((avg / profile.personalBest) * 100);
        document.getElementById('statAvgPctBest').textContent = avgPctBest + '%';
      } else {
        document.getElementById('statAvgPctBest').textContent = '--%';
      }

      // Dygnsvariabilitet: kliniskt korrekt ber√§kning (morgon vs kv√§ll)
      const variability = calculateDailyVariability(recent);
      document.getElementById('statVariability').textContent = variability !== null ? Math.round(variability) + '%' : '--%';
    }

    // Ber√§knar kliniskt korrekt dygnsvariabilitet
    // Kr√§ver m√§tningar b√•de morgon (05-10) och kv√§ll (18-23)
    function calculateDailyVariability(measurements) {
      // Gruppera m√§tningar per dag
      const byDay = new Map();

      for (const m of measurements) {
        const date = new Date(m.ts);
        const dayKey = date.toISOString().slice(0, 10);
        const hour = date.getHours();

        if (!byDay.has(dayKey)) {
          byDay.set(dayKey, { morning: [], evening: [] });
        }

        // Morgon: 05:00-09:59
        if (hour >= 5 && hour < 10) {
          byDay.get(dayKey).morning.push(m.pef);
        }
        // Kv√§ll: 18:00-22:59
        else if (hour >= 18 && hour < 23) {
          byDay.get(dayKey).evening.push(m.pef);
        }
        // √ñvriga tider r√§knas inte in i variabiliteten
      }

      // Ber√§kna variabilitet f√∂r dagar med b√•de morgon- och kv√§llsv√§rden
      const dailyVariabilities = [];

      for (const [day, values] of byDay) {
        if (values.morning.length > 0 && values.evening.length > 0) {
          const morningBest = Math.max(...values.morning);
          const eveningBest = Math.max(...values.evening);
          const higher = Math.max(morningBest, eveningBest);
          const lower = Math.min(morningBest, eveningBest);
          const dayVariability = ((higher - lower) / higher) * 100;
          dailyVariabilities.push(dayVariability);
        }
      }

      if (dailyVariabilities.length === 0) {
        return null;
      }

      return dailyVariabilities.reduce((sum, v) => sum + v, 0) / dailyVariabilities.length;
    }

    // Returnerar detaljerad data per dag f√∂r visning och export
    function getDailyVariabilityDetails(measurements) {
      const byDay = new Map();

      for (const m of measurements) {
        const date = new Date(m.ts);
        const dayKey = date.toISOString().slice(0, 10);
        const hour = date.getHours();

        if (!byDay.has(dayKey)) {
          byDay.set(dayKey, { morning: [], evening: [] });
        }

        if (hour >= 5 && hour < 10) {
          byDay.get(dayKey).morning.push(m.pef);
        } else if (hour >= 18 && hour < 23) {
          byDay.get(dayKey).evening.push(m.pef);
        }
      }

      const details = [];

      for (const [day, values] of byDay) {
        if (values.morning.length > 0 && values.evening.length > 0) {
          const morningBest = Math.max(...values.morning);
          const eveningBest = Math.max(...values.evening);
          const higher = Math.max(morningBest, eveningBest);
          const lower = Math.min(morningBest, eveningBest);
          const variability = ((higher - lower) / higher) * 100;

          details.push({
            date: day,
            morning: morningBest,
            evening: eveningBest,
            variability: Math.round(variability)
          });
        }
      }

      // Sortera senaste f√∂rst
      return details.sort((a, b) => b.date.localeCompare(a.date));
    }

    let showVariabilityDetails = false;

    function toggleVariabilityDetails() {
      showVariabilityDetails = !showVariabilityDetails;
      const container = document.getElementById('variabilityDetails');
      container.style.display = showVariabilityDetails ? 'block' : 'none';

      if (showVariabilityDetails) {
        updateVariabilityList();
      }
    }

    function updateVariabilityList() {
      const list = document.getElementById('variabilityList');
      const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
      const recent = measurements.filter(m => m.ts >= thirtyDaysAgo);
      const details = getDailyVariabilityDetails(recent);

      if (details.length === 0) {
        list.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);">Logga morgon- och kv√§llsv√§rden f√∂r att se daglig variabilitet</div>';
        return;
      }

      list.innerHTML = details.map(d => {
        const dateStr = new Date(d.date).toLocaleDateString('sv-SE', { weekday: 'short', day: 'numeric', month: 'short' });
        let colorClass = 'good';
        if (d.variability >= 20) colorClass = 'poor';
        else if (d.variability >= 10) colorClass = 'moderate';

        return `
          <div class="variability-item">
            <div>
              <div class="variability-date">${dateStr}</div>
              <div class="variability-values">M: ${d.morning} / K: ${d.evening}</div>
            </div>
            <div class="variability-percent ${colorClass}">${d.variability}%</div>
          </div>
        `;
      }).join('');
    }

    function updateProfileBadge() {
      const badge = document.getElementById('profileBadgeText');
      if (profile.name) {
        badge.textContent = profile.name;
      } else if (profile.birthYear && profile.heightCm) {
        const age = calculateAge(profile.birthYear, profile.birthMonth);
        badge.textContent = `${age} √•r, ${profile.heightCm} cm`;
      } else {
        badge.textContent = 'Ange profil';
      }
    }

    // ============================================
    // Chart
    // ============================================

    function dailyBuckets() {
      const byDay = new Map();

      for (const m of measurements) {
        const d = new Date(m.ts);
        d.setHours(0, 0, 0, 0);
        const key = d.toISOString();

        if (!byDay.has(key)) {
          byDay.set(key, []);
        }
        byDay.get(key).push(m.pef);
      }

      return [...byDay.entries()]
        .map(([iso, arr]) => ({
          day: iso,
          best: Math.max(...arr),
          mean: Math.round(arr.reduce((a, b) => a + b, 0) / arr.length),
          count: arr.length
        }))
        .sort((a, b) => a.day.localeCompare(b.day));
    }

    function rollingAverage(data, days, valueKey = 'best') {
      return data.map((item, idx) => {
        const start = Math.max(0, idx - days + 1);
        const window = data.slice(start, idx + 1);
        const avg = window.reduce((sum, d) => sum + d[valueKey], 0) / window.length;
        return { day: item.day, value: Math.round(avg) };
      });
    }

    function updateChart() {
      const canvas = document.getElementById('pefChart');
      const ctx = canvas.getContext('2d');

      if (chart) {
        chart.destroy();
      }

      const daily = dailyBuckets();

      const textColor = darkMode ? '#e5e7eb' : '#374151';
      const gridColor = darkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';

      // Best√§m referensv√§rde baserat p√• l√§ge
      let reference = null;
      let missingRef = false;

      if (refMode === 'predicted') {
        reference = profile.predicted;
        if (!reference) missingRef = true;
      } else {
        reference = profile.personalBest;
        if (!reference) missingRef = true;
      }

      // Fallback om referens saknas
      if (missingRef || !reference || reference <= 0) {
        chart = new Chart(ctx, {
          type: 'line',
          data: { labels: [], datasets: [] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: refMode === 'predicted'
                  ? 'Fyll i profil f√∂r f√∂rv√§ntat v√§rde'
                  : 'Logga m√§tningar f√∂r personb√§sta',
                color: textColor,
                font: { size: 14 }
              }
            },
            scales: {
              x: { display: false },
              y: { display: false }
            }
          }
        });
        return;
      }

      if (daily.length === 0) {
        chart = new Chart(ctx, {
          type: 'line',
          data: { labels: [], datasets: [] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: { ticks: { color: textColor } },
              y: { ticks: { color: textColor } }
            }
          }
        });
        return;
      }

      const last30 = daily.slice(-30);

      // Konvertera till procent
      const last30WithPercent = last30.map(d => ({
        ...d,
        percent: Math.round((d.best / reference) * 100)
      }));

      // Ber√§kna 7-dagars medel p√• procentv√§rden
      const r7 = rollingAverage(last30WithPercent, 7, 'percent');

      const labels = last30.map(d => {
        const date = new Date(d.day);
        return date.toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' });
      });

      // Y-axel f√∂r procent (dynamisk med marginal, min 0, max minst 120%)
      const maxPercent = Math.max(...last30WithPercent.map(d => d.percent), 100);
      const maxY = Math.round(Math.max(maxPercent * 1.1, 120));

      // Zonlinjer i procent
      const greenLine = 80;  // 80% = gr√∂n zon
      const yellowLine = 50; // 50% = gul zon

      const refLabel = refMode === 'predicted' ? 'f√∂rv√§ntat' : 'personb√§sta';

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: `% av ${refLabel}`,
              data: last30WithPercent.map(d => d.percent),
              borderColor: '#6366f1',
              backgroundColor: darkMode ? 'rgba(99, 102, 241, 0.2)' : 'rgba(99, 102, 241, 0.1)',
              borderWidth: 2,
              pointRadius: 4,
              pointBackgroundColor: '#6366f1',
              tension: 0.3,
              fill: true
            },
            {
              label: '7-dagars medel',
              data: r7.map(d => d.value),
              borderColor: '#f59e0b',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.3,
              borderDash: [5, 5]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          scales: {
            y: {
              min: 0,
              max: maxY,
              grid: { color: gridColor },
              ticks: {
                color: textColor,
                callback: function(value) {
                  return value + '%';
                }
              }
            },
            x: {
              grid: { display: false },
              ticks: { maxTicksLimit: 6, color: textColor }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: { boxWidth: 12, padding: 16, color: textColor }
            },
            tooltip: {
              backgroundColor: darkMode ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.8)',
              titleColor: darkMode ? '#111' : '#fff',
              bodyColor: darkMode ? '#111' : '#fff',
              padding: 12,
              cornerRadius: 8,
              callbacks: {
                label: function(context) {
                  const idx = context.dataIndex;
                  const percent = context.raw;
                  const absolute = last30[idx]?.best || 0;
                  if (context.datasetIndex === 0) {
                    return `${percent}% (${absolute} L/min)`;
                  }
                  return `${percent}%`;
                }
              }
            }
          }
        },
        plugins: [{
          id: 'zoneBands',
          beforeDraw(chart) {
            const { ctx, chartArea, scales } = chart;
            if (!chartArea) return;

            const y = scales.y;

            // Gr√∂n zon: >= 80%
            ctx.fillStyle = darkMode ? 'rgba(16, 185, 129, 0.15)' : 'rgba(16, 185, 129, 0.1)';
            ctx.fillRect(chartArea.left, y.getPixelForValue(maxY), chartArea.right - chartArea.left, y.getPixelForValue(greenLine) - y.getPixelForValue(maxY));

            // Gul zon: 50-79%
            ctx.fillStyle = darkMode ? 'rgba(245, 158, 11, 0.15)' : 'rgba(245, 158, 11, 0.1)';
            ctx.fillRect(chartArea.left, y.getPixelForValue(greenLine), chartArea.right - chartArea.left, y.getPixelForValue(yellowLine) - y.getPixelForValue(greenLine));

            // R√∂d zon: < 50%
            ctx.fillStyle = darkMode ? 'rgba(239, 68, 68, 0.15)' : 'rgba(239, 68, 68, 0.1)';
            ctx.fillRect(chartArea.left, y.getPixelForValue(yellowLine), chartArea.right - chartArea.left, y.getPixelForValue(0) - y.getPixelForValue(yellowLine));
          }
        }]
      });
    }

    function setRefMode(mode) {
      refMode = mode;
      document.querySelectorAll('.ref-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.ref === mode);
      });

      measurements = measurements.map(m => ({ ...m, zone: getZone(m.pef) }));
      saveData();

      updateChart();
      updateStatistics();
    }

    // ============================================
    // Profile
    // ============================================

    function selectSex(sex) {
      document.querySelectorAll('.sex-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.sex === sex);
      });
      updatePredictedDisplay();
    }

    function showProfileModal() {
      document.getElementById('profileName').value = profile.name || '';
      document.getElementById('profileBirthYear').value = profile.birthYear || '';
      document.getElementById('profileBirthMonth').value = profile.birthMonth || '';
      document.getElementById('profileHeight').value = profile.heightCm || '';
      document.getElementById('profileAlgorithm').value = profile.algorithm || 'eu';

      document.querySelectorAll('.sex-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.sex === (profile.sex || 'male'));
      });

      // Medication fields
      if (profile.currentMedication) {
        document.getElementById('profileInhaler').value = profile.currentMedication.inhaler || '';
        updateInhalerStrengths();
        document.getElementById('profileInhalerStrength').value = profile.currentMedication.strength || '';
        document.getElementById('profileMedStartDate').value = profile.currentMedication.startDate || '';
        if (profile.currentMedication.inhaler === 'other') {
          document.getElementById('customInhalerGroup').style.display = 'block';
          document.getElementById('profileInhalerCustom').value = profile.currentMedication.customName || '';
        }
      } else {
        document.getElementById('profileInhaler').value = '';
        document.getElementById('profileInhalerStrength').innerHTML = '<option value="">V√§lj styrka...</option>';
        document.getElementById('profileMedStartDate').value = '';
      }

      updateMedicationHistory();
      updatePredictedDisplay();
      document.getElementById('profileModal').classList.add('active');
    }

    function hideProfileModal() {
      document.getElementById('profileModal').classList.remove('active');
    }

    const inhalerStrengths = {
      'symbicort': ['80/4.5 ¬µg', '160/4.5 ¬µg', '320/9 ¬µg'],
      'innovair': ['100/6 ¬µg', '200/6 ¬µg'],
      'seretide': ['50/100 ¬µg', '50/250 ¬µg', '50/500 ¬µg'],
      'bufomix': ['160/4.5 ¬µg', '320/9 ¬µg'],
      'relvar': ['92/22 ¬µg', '184/22 ¬µg'],
      'duoresp': ['160/4.5 ¬µg', '320/9 ¬µg'],
      'pulmicort': ['100 ¬µg', '200 ¬µg', '400 ¬µg'],
      'flutide': ['50 ¬µg', '125 ¬µg', '250 ¬µg'],
      'giona': ['100 ¬µg', '250 ¬µg'],
      'ventoline': ['100 ¬µg/dos'],
      'bricanyl': ['250 ¬µg', '500 ¬µg'],
      'atrovent': ['20 ¬µg', '40 ¬µg'],
      'spiriva': ['18 ¬µg', '2.5 ¬µg']
    };

    function updateInhalerStrengths() {
      const inhaler = document.getElementById('profileInhaler').value;
      const strengthSelect = document.getElementById('profileInhalerStrength');
      const customGroup = document.getElementById('customInhalerGroup');

      // Show/hide custom input
      customGroup.style.display = inhaler === 'other' ? 'block' : 'none';

      // Update strengths
      strengthSelect.innerHTML = '<option value="">V√§lj styrka...</option>';

      if (inhaler && inhaler !== 'other' && inhalerStrengths[inhaler]) {
        inhalerStrengths[inhaler].forEach(strength => {
          const option = document.createElement('option');
          option.value = strength;
          option.textContent = strength;
          strengthSelect.appendChild(option);
        });
      } else if (inhaler === 'other') {
        // Allow free text for custom
        strengthSelect.innerHTML = '<option value="">Ange styrka...</option>';
        const customOption = document.createElement('option');
        customOption.value = 'custom';
        customOption.textContent = 'Ange egen styrka';
        strengthSelect.appendChild(customOption);
      }
    }

    function updateMedicationHistory() {
      const container = document.getElementById('medicationHistory');
      if (!profile.medicationHistory || profile.medicationHistory.length === 0) {
        container.innerHTML = '';
        return;
      }

      const html = profile.medicationHistory.map((med, idx) => {
        const isCurrent = profile.currentMedication &&
          med.inhaler === profile.currentMedication.inhaler &&
          med.startDate === profile.currentMedication.startDate;

        const name = med.inhaler === 'other' ? med.customName : getInhalerName(med.inhaler);

        return `
          <div class="med-history-item">
            <div>
              <span class="med-name">${name} ${med.strength || ''}</span>
              <span class="med-date">fr√•n ${med.startDate || 'ok√§nt datum'}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              ${isCurrent ? '<span class="med-current">Aktuell</span>' : ''}
              <button class="btn-icon" onclick="deleteMedication(${idx})" title="Ta bort" style="color: var(--danger); padding: 4px;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = '<label class="form-label" style="margin-top: 12px;">Medicinhistorik</label>' + html;
    }

    function deleteMedication(idx) {
      if (!confirm('Ta bort denna medicinering fr√•n historiken?')) return;

      const deletedMed = profile.medicationHistory[idx];
      profile.medicationHistory.splice(idx, 1);

      // If deleted was current, clear current medication
      if (profile.currentMedication &&
          deletedMed.inhaler === profile.currentMedication.inhaler &&
          deletedMed.startDate === profile.currentMedication.startDate) {
        profile.currentMedication = profile.medicationHistory.length > 0 ? profile.medicationHistory[0] : null;
      }

      saveData();
      updateMedicationHistory();
      showToast('Medicinering borttagen', 'success');
    }

    function getInhalerName(value) {
      const names = {
        'symbicort': 'Symbicort',
        'innovair': 'Innovair',
        'seretide': 'Seretide',
        'bufomix': 'Bufomix',
        'relvar': 'Relvar',
        'duoresp': 'DuoResp',
        'pulmicort': 'Pulmicort',
        'flutide': 'Flutide',
        'giona': 'Giona',
        'ventoline': 'Ventoline',
        'bricanyl': 'Bricanyl',
        'atrovent': 'Atrovent',
        'spiriva': 'Spiriva'
      };
      return names[value] || value;
    }

    function updatePredictedDisplay() {
      const sex = document.querySelector('.sex-option.active')?.dataset.sex || 'male';
      const birthYear = parseInt(document.getElementById('profileBirthYear').value);
      const birthMonth = parseInt(document.getElementById('profileBirthMonth').value);
      const height = parseInt(document.getElementById('profileHeight').value);
      const algorithm = document.getElementById('profileAlgorithm').value || 'eu';

      if (birthYear && height) {
        const tempProfile = { sex, birthYear, birthMonth, heightCm: height, algorithm };
        const predicted = calculatePredictedPEF(tempProfile);
        document.getElementById('predictedDisplay').textContent = predicted ? `${predicted} L/min` : '-- L/min';
      } else {
        document.getElementById('predictedDisplay').textContent = '-- L/min';
      }
    }

    function saveProfile() {
      profile.name = document.getElementById('profileName').value.trim();
      profile.sex = document.querySelector('.sex-option.active')?.dataset.sex || 'male';
      profile.birthYear = parseInt(document.getElementById('profileBirthYear').value) || null;
      profile.birthMonth = parseInt(document.getElementById('profileBirthMonth').value) || null;
      profile.heightCm = parseInt(document.getElementById('profileHeight').value) || null;
      profile.algorithm = document.getElementById('profileAlgorithm').value || 'eu';
      profile.predicted = calculatePredictedPEF();

      // Save medication
      const inhaler = document.getElementById('profileInhaler').value;
      const strength = document.getElementById('profileInhalerStrength').value;
      const startDate = document.getElementById('profileMedStartDate').value;
      const customName = document.getElementById('profileInhalerCustom').value.trim();

      if (inhaler) {
        const newMedication = {
          inhaler,
          strength,
          startDate,
          customName: inhaler === 'other' ? customName : null
        };

        // Check if medication changed
        const currentMed = profile.currentMedication;
        const medChanged = !currentMed ||
          currentMed.inhaler !== inhaler ||
          currentMed.strength !== strength ||
          currentMed.startDate !== startDate;

        if (medChanged) {
          profile.currentMedication = newMedication;

          // Add to history if not already there
          if (!profile.medicationHistory) profile.medicationHistory = [];

          const exists = profile.medicationHistory.some(m =>
            m.inhaler === inhaler &&
            m.strength === strength &&
            m.startDate === startDate
          );

          if (!exists && startDate) {
            profile.medicationHistory.push(newMedication);
            // Sort by date descending
            profile.medicationHistory.sort((a, b) =>
              new Date(b.startDate || 0) - new Date(a.startDate || 0)
            );
          }
        }
      }

      measurements = measurements.map(m => ({ ...m, zone: getZone(m.pef) }));

      saveData();
      hideProfileModal();
      updateUI();
      showToast('Profil sparad!', 'success');
    }

    // ============================================
    // Export Functions
    // ============================================

    function exportCSV() {
      if (measurements.length === 0) {
        showToast('Inga m√§tningar att exportera', 'error');
        return;
      }

      const headers = ['Datum', 'Tid', 'PEF (L/min)', 'Zon', '% av referens'];
      const reference = profile.predicted || profile.personalBest || 500;

      const rows = measurements.map(m => {
        const date = new Date(m.ts);
        const pct = Math.round(100 * m.pef / reference);
        return [
          date.toLocaleDateString('sv-SE'),
          date.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' }),
          m.pef,
          m.zone === 'green' ? 'Gr√∂n' : m.zone === 'yellow' ? 'Gul' : 'R√∂d',
          pct + '%'
        ];
      });

      const csv = [headers, ...rows].map(row => row.join(';')).join('\n');
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `pef-export-${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('CSV exporterad!', 'success');
    }

    function exportBackup() {
      const backup = {
        version: 1,
        exportDate: new Date().toISOString(),
        profile: profile,
        measurements: measurements
      };

      const json = JSON.stringify(backup, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `pef-backup-${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('Backup exporterad!', 'success');
    }

    function importBackup(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const backup = JSON.parse(e.target.result);

          // Validera backup-strukturen
          if (!backup.measurements || !Array.isArray(backup.measurements)) {
            showToast('Ogiltig backup-fil', 'error');
            return;
          }

          // Bekr√§fta innan import
          const count = backup.measurements.length;
          const existingCount = measurements.length;

          let message = `Importera ${count} m√§tningar`;
          if (existingCount > 0) {
            message += `?\n\nDu har ${existingCount} befintliga m√§tningar. V√§lj:\n‚Ä¢ OK = Sl√• ihop (beh√•ll b√•da)\n‚Ä¢ Avbryt f√∂r att avbryta`;
          }

          if (!confirm(message)) {
            event.target.value = '';
            return;
          }

          // Importera profil om den finns
          if (backup.profile) {
            profile = { ...profile, ...backup.profile };
            localStorage.setItem('pef_profile', JSON.stringify(profile));
          }

          // Sl√• ihop m√§tningar (undvik dubbletter baserat p√• timestamp)
          const existingTimestamps = new Set(measurements.map(m => m.ts));
          const newMeasurements = backup.measurements.filter(m => !existingTimestamps.has(m.ts));

          measurements = [...measurements, ...newMeasurements].sort((a, b) => b.ts - a.ts);
          localStorage.setItem('pef_measurements', JSON.stringify(measurements));

          updateUI();
          showToast(`${newMeasurements.length} nya m√§tningar importerade!`, 'success');

        } catch (error) {
          console.error('Import error:', error);
          showToast('Kunde inte l√§sa backup-filen', 'error');
        }

        event.target.value = '';
      };

      reader.readAsText(file);
    }

    function exportPDF() {
      if (measurements.length === 0) {
        showToast('Inga m√§tningar att exportera', 'error');
        return;
      }

      try {
        // Check if jsPDF is loaded
        if (!window.jspdf || !window.jspdf.jsPDF) {
          showToast('PDF-biblioteket laddas, f√∂rs√∂k igen om en sekund', 'error');
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        let y = 20;

      doc.setFontSize(24);
      doc.setFont('helvetica', 'bold');
      doc.text('PEF-rapport', 20, y);
      y += 15;

      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      const firstDate = new Date(Math.min(...measurements.map(m => m.ts)));
      const lastDate = new Date(Math.max(...measurements.map(m => m.ts)));
      doc.text(`Period: ${firstDate.toLocaleDateString('sv-SE')} - ${lastDate.toLocaleDateString('sv-SE')}`, 20, y);
      y += 12;

      if (profile.name) {
        doc.text(`Patient: ${profile.name}`, 20, y);
        y += 8;
      }

      if (profile.birthYear) {
        const age = calculateAge(profile.birthYear, profile.birthMonth);
        doc.text(`${profile.sex === 'female' ? 'Kvinna' : 'Man'}, ${age} √•r, ${profile.heightCm || '-'} cm`, 20, y);
        y += 8;
      }

      if (profile.predicted) {
        doc.text(`F√∂rv√§ntat PEF: ${profile.predicted} L/min`, 20, y);
        y += 8;
      }

      if (profile.personalBest) {
        doc.text(`Personb√§sta: ${profile.personalBest} L/min`, 20, y);
        y += 8;
      }

      // Medicinering
      if (profile.currentMedication && profile.currentMedication.inhaler) {
        const medName = profile.currentMedication.inhaler === 'other'
          ? profile.currentMedication.customName
          : getInhalerName(profile.currentMedication.inhaler);
        const medStrength = profile.currentMedication.strength || '';
        doc.text(`Aktuell medicinering: ${medName} ${medStrength}`, 20, y);
        y += 8;
        if (profile.currentMedication.startDate) {
          doc.text(`Sedan: ${profile.currentMedication.startDate}`, 20, y);
          y += 8;
        }
      }

      y += 10;

      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('Sammanfattning', 20, y);
      y += 10;

      const values = measurements.map(m => m.pef);
      const best = Math.max(...values);
      const low = Math.min(...values);
      const avg = Math.round(values.reduce((a, b) => a + b, 0) / values.length);

      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      doc.text(`Antal m√§tningar: ${measurements.length}`, 20, y); y += 7;
      doc.text(`H√∂gsta v√§rde: ${best} L/min`, 20, y); y += 7;
      doc.text(`L√§gsta v√§rde: ${low} L/min`, 20, y); y += 7;
      doc.text(`Medelv√§rde: ${avg} L/min`, 20, y); y += 7;

      const greenCount = measurements.filter(m => m.zone === 'green').length;
      const yellowCount = measurements.filter(m => m.zone === 'yellow').length;
      const redCount = measurements.filter(m => m.zone === 'red').length;

      doc.text(`Gr√∂n zon: ${Math.round(100 * greenCount / measurements.length)}%`, 20, y); y += 7;
      doc.text(`Gul zon: ${Math.round(100 * yellowCount / measurements.length)}%`, 20, y); y += 7;
      doc.text(`R√∂d zon: ${Math.round(100 * redCount / measurements.length)}%`, 20, y); y += 10;

      // Procent-statistik
      const reference = profile.predicted || profile.personalBest;
      if (reference && reference > 0) {
        const avgPct = Math.round((avg / reference) * 100);
        const lowPct = Math.round((low / reference) * 100);
        doc.text(`Snitt % av f√∂rv√§ntat: ${avgPct}%`, 20, y); y += 7;
        doc.text(`L√§gsta % av f√∂rv√§ntat: ${lowPct}%`, 20, y); y += 7;
      }
      if (profile.personalBest && profile.personalBest > 0) {
        const avgPctBest = Math.round((avg / profile.personalBest) * 100);
        doc.text(`Snitt % av personb√§sta: ${avgPctBest}%`, 20, y); y += 7;
      }
      y += 8;

      // Symptom-sammanfattning
      const symptomMeasurements = measurements.filter(m => m.symptom && m.symptom !== 'frisk');
      const healthyMeasurements = measurements.filter(m => !m.symptom || m.symptom === 'frisk');
      if (symptomMeasurements.length > 0 || healthyMeasurements.length > 0) {
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Symptom', 20, y);
        y += 10;
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');

        doc.text(`Friska m√§tningar: ${healthyMeasurements.length}`, 20, y); y += 7;
        doc.text(`M√§tningar med symptom: ${symptomMeasurements.length}`, 20, y); y += 7;

        if (symptomMeasurements.length > 0 && healthyMeasurements.length > 0) {
          const healthyAvg = Math.round(healthyMeasurements.reduce((sum, m) => sum + m.pef, 0) / healthyMeasurements.length);
          const symptomAvg = Math.round(symptomMeasurements.reduce((sum, m) => sum + m.pef, 0) / symptomMeasurements.length);
          doc.text(`Snitt PEF frisk: ${healthyAvg} L/min`, 20, y); y += 7;
          doc.text(`Snitt PEF med symptom: ${symptomAvg} L/min`, 20, y); y += 7;
          if (healthyAvg > 0) {
            const diff = Math.round(((healthyAvg - symptomAvg) / healthyAvg) * 100);
            doc.text(`Skillnad: ${diff}% l√§gre vid symptom`, 20, y); y += 7;
          }
        }

        // Symptom-f√∂rdelning
        const forkyldCount = symptomMeasurements.filter(m => m.symptom === 'forkyld').length;
        const hostaCount = symptomMeasurements.filter(m => m.symptom === 'hosta').length;
        const allergiCount = symptomMeasurements.filter(m => m.symptom === 'allergi').length;
        if (forkyldCount > 0) { doc.text(`  - F√∂rkyld: ${forkyldCount} m√§tningar`, 20, y); y += 7; }
        if (hostaCount > 0) { doc.text(`  - Hosta: ${hostaCount} m√§tningar`, 20, y); y += 7; }
        if (allergiCount > 0) { doc.text(`  - Allergi: ${allergiCount} m√§tningar`, 20, y); y += 7; }
        y += 8;
      }

      // AI-insikter
      const insights = getInsightsData();
      if (insights.length > 0) {
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('AI-analys', 20, y);
        y += 10;
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');

        insights.forEach(insight => {
          doc.setFont('helvetica', 'bold');
          doc.text(`‚Ä¢ ${insight.title}`, 20, y);
          y += 6;
          doc.setFont('helvetica', 'normal');

          // Wrap long text
          const textLines = doc.splitTextToSize(insight.text, 170);
          textLines.forEach(line => {
            doc.text(line, 25, y);
            y += 5;
          });
          y += 3;
        });
        y += 5;
      }

      // Dygnsvariabilitet per dag
      const variabilityDetails = getDailyVariabilityDetails(measurements);
      if (variabilityDetails.length > 0) {
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Dygnsvariabilitet', 20, y);
        y += 10;

        const avgVariability = variabilityDetails.reduce((sum, d) => sum + d.variability, 0) / variabilityDetails.length;
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        doc.text(`Medelv√§rde: ${Math.round(avgVariability)}%`, 20, y);
        y += 8;

        const variabilityTableData = variabilityDetails.slice(0, 14).map(d => {
          const dateStr = new Date(d.date).toLocaleDateString('sv-SE');
          let status = 'Bra';
          if (d.variability >= 20) status = 'H√∂g';
          else if (d.variability >= 10) status = 'M√•ttlig';
          return [dateStr, `${d.morning}`, `${d.evening}`, `${d.variability}%`, status];
        });

        doc.autoTable({
          startY: y,
          head: [['Datum', 'Morgon', 'Kv√§ll', 'Variabilitet', 'Status']],
          body: variabilityTableData,
          styles: { fontSize: 9 },
          headStyles: { fillColor: [99, 102, 241] },
          columnStyles: {
            4: { fontStyle: 'bold' }
          }
        });

        y = doc.lastAutoTable.finalY + 15;
      }

      const chartCanvas = document.getElementById('pefChart');
      if (chartCanvas) {
        const chartImg = chartCanvas.toDataURL('image/png', 1.0);
        const imgWidth = 170;
        const imgHeight = (chartCanvas.height / chartCanvas.width) * imgWidth;
        doc.addImage(chartImg, 'PNG', 20, y, imgWidth, imgHeight);
        y += imgHeight + 15;
      }

      if (y > 250) {
        doc.addPage();
        y = 20;
      }

      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('M√§tningar', 20, y);
      y += 10;

      const tableData = measurements
        .sort((a, b) => b.ts - a.ts)
        .slice(0, 50)
        .map(m => {
          const date = new Date(m.ts);
          const ref = profile.predicted || profile.personalBest || 500;
          const pct = Math.round(100 * m.pef / ref);
          const symptomText = {
            'frisk': '',
            'forkyld': 'F√∂rkyld',
            'hosta': 'Hosta',
            'allergi': 'Allergi'
          }[m.symptom] || '';
          return [
            date.toLocaleDateString('sv-SE'),
            date.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' }),
            `${m.pef} L/min`,
            `${pct}%`,
            m.zone === 'green' ? 'Gr√∂n' : m.zone === 'yellow' ? 'Gul' : 'R√∂d',
            symptomText
          ];
        });

      doc.autoTable({
        startY: y,
        head: [['Datum', 'Tid', 'V√§rde', '%', 'Zon', 'Status']],
        body: tableData,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [99, 102, 241] }
      });

      doc.save(`pef-rapport-${new Date().toISOString().slice(0, 10)}.pdf`);
      showToast('PDF-rapport skapad!', 'success');

      } catch (error) {
        console.error('PDF export error:', error);
        showToast('Kunde inte skapa PDF. F√∂rs√∂k igen.', 'error');
      }
    }

    // ============================================
    // Navigation
    // ============================================

    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      document.getElementById(sectionId).style.display = 'block';

      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.section === sectionId);
      });

      if (sectionId === 'sectionStats') {
        updateChart();
        updateInsights();
      }
    }

    // ============================================
    // Toast
    // ============================================

    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ============================================
    // PWA Install
    // ============================================

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installBanner').classList.add('show');
    });

    function installApp() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(() => {
        deferredPrompt = null;
        document.getElementById('installBanner').classList.remove('show');
      });
    }

    // Service Worker med uppdateringsdetektering
    let newWorker = null;

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').then(reg => {
        // Kolla efter uppdateringar direkt vid start
        reg.update();

        // Lyssna p√• nya versioner
        reg.addEventListener('updatefound', () => {
          newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Ny version installerad - visa banner
              document.getElementById('updateBanner').classList.add('show');
            }
          });
        });
      }).catch(() => {});

      // N√§r ny service worker tar √∂ver, ladda om sidan
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    }

    function applyUpdate() {
      if (newWorker) {
        newWorker.postMessage({ type: 'SKIP_WAITING' });
      } else {
        // Fallback: force reload
        window.location.reload(true);
      }
    }

    // ============================================
    // AI Analysis (Pattern Analysis + TensorFlow.js)
    // ============================================

    let tfModel = null;
    let isModelTraining = false;

    // Pattern Analysis (Alternativ 1 - fungerar direkt)
    function analyzePatterns() {
      const container = document.getElementById('insightsContainer');
      const insights = [];

      if (measurements.length < 3) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 20px;">
            <p>Logga minst 3 m√§tningar f√∂r att f√• insikter</p>
          </div>
        `;
        return;
      }

      const now = Date.now();
      const sevenDaysAgo = now - 7 * 24 * 60 * 60 * 1000;
      const fourteenDaysAgo = now - 14 * 24 * 60 * 60 * 1000;

      const recent = measurements.filter(m => m.ts >= sevenDaysAgo);
      const previous = measurements.filter(m => m.ts >= fourteenDaysAgo && m.ts < sevenDaysAgo);

      // 1. Trend analysis
      if (recent.length >= 3) {
        const recentAvg = recent.reduce((sum, m) => sum + m.pef, 0) / recent.length;

        if (previous.length >= 3) {
          const prevAvg = previous.reduce((sum, m) => sum + m.pef, 0) / previous.length;
          const change = ((recentAvg - prevAvg) / prevAvg) * 100;

          if (change <= -10) {
            insights.push({
              icon: 'üìâ',
              title: 'Ned√•tg√•ende trend',
              text: `Dina v√§rden har sjunkit ${Math.abs(Math.round(change))}% j√§mf√∂rt med f√∂rra veckan.`,
              type: 'warning'
            });
          } else if (change >= 10) {
            insights.push({
              icon: 'üìà',
              title: 'Upp√•tg√•ende trend',
              text: `Dina v√§rden har √∂kat ${Math.round(change)}% j√§mf√∂rt med f√∂rra veckan.`,
              type: 'success'
            });
          } else {
            insights.push({
              icon: '‚û°Ô∏è',
              title: 'Stabila v√§rden',
              text: 'Dina v√§rden har varit stabila den senaste veckan.',
              type: 'info'
            });
          }
        }
      }

      // 2. Variability analysis (kliniskt viktigt!)
      if (recent.length >= 4) {
        const values = recent.map(m => m.pef);
        const max = Math.max(...values);
        const min = Math.min(...values);
        const mean = values.reduce((a, b) => a + b, 0) / values.length;
        const variability = ((max - min) / mean) * 100;

        if (variability > 20) {
          insights.push({
            icon: '‚ö†Ô∏è',
            title: 'H√∂g variabilitet',
            text: `${Math.round(variability)}% variation mellan h√∂gsta och l√§gsta v√§rde. >20% kan tyda p√• d√•ligt kontrollerad astma.`,
            type: 'danger'
          });
        } else if (variability > 15) {
          insights.push({
            icon: 'üìä',
            title: 'M√•ttlig variabilitet',
            text: `${Math.round(variability)}% variation. H√•ll koll p√• utvecklingen.`,
            type: 'warning'
          });
        } else {
          insights.push({
            icon: '‚úì',
            title: 'L√•g variabilitet',
            text: `Endast ${Math.round(variability)}% variation - bra kontroll!`,
            type: 'success'
          });
        }
      }

      // 3. Morning dip analysis
      const morningMeasurements = measurements.filter(m => {
        const hour = new Date(m.ts).getHours();
        return hour >= 5 && hour < 10;
      }).slice(-14);

      const eveningMeasurements = measurements.filter(m => {
        const hour = new Date(m.ts).getHours();
        return hour >= 18 && hour < 23;
      }).slice(-14);

      if (morningMeasurements.length >= 3 && eveningMeasurements.length >= 3) {
        const morningAvg = morningMeasurements.reduce((sum, m) => sum + m.pef, 0) / morningMeasurements.length;
        const eveningAvg = eveningMeasurements.reduce((sum, m) => sum + m.pef, 0) / eveningMeasurements.length;
        const dip = ((eveningAvg - morningAvg) / eveningAvg) * 100;

        if (dip > 15) {
          insights.push({
            icon: 'üåÖ',
            title: 'Morgondipp',
            text: `Morgonv√§rden √§r ${Math.round(dip)}% l√§gre √§n kv√§llsv√§rden. Detta kan tyda p√• nattlig astma.`,
            type: 'warning'
          });
        } else if (dip > 8) {
          insights.push({
            icon: 'üåÖ',
            title: 'Visst morgondipp',
            text: `Morgonv√§rden √§r ${Math.round(dip)}% l√§gre √§n kv√§llsv√§rden.`,
            type: 'info'
          });
        }
      }

      // 4. Red zone warnings
      const recentRed = recent.filter(m => m.zone === 'red');
      if (recentRed.length >= 2) {
        insights.push({
          icon: 'üö®',
          title: 'Flera r√∂da m√§tningar',
          text: `${recentRed.length} m√§tningar i r√∂d zon senaste veckan. √ñverv√§g att kontakta v√•rden.`,
          type: 'danger'
        });
      }

      // 5. Symptom analysis
      const symptomsRecent = recent.filter(m => m.symptom && m.symptom !== 'frisk');
      const healthyRecent = recent.filter(m => !m.symptom || m.symptom === 'frisk');

      if (symptomsRecent.length >= 2 && healthyRecent.length >= 2) {
        const symptomAvg = symptomsRecent.reduce((sum, m) => sum + m.pef, 0) / symptomsRecent.length;
        const healthyAvg = healthyRecent.reduce((sum, m) => sum + m.pef, 0) / healthyRecent.length;
        const drop = ((healthyAvg - symptomAvg) / healthyAvg) * 100;

        if (drop > 5) {
          const mainSymptom = getMostCommonSymptom(symptomsRecent);
          const symptomName = {
            'forkyld': 'f√∂rkylning',
            'hosta': 'hosta',
            'allergi': 'allergi'
          }[mainSymptom] || 'symptom';

          insights.push({
            icon: 'ü§ß',
            title: 'Symptomp√•verkan',
            text: `Vid ${symptomName} sjunker ditt PEF med ca ${Math.round(drop)}% j√§mf√∂rt med friska dagar.`,
            type: 'info'
          });
        }
      }

      // 6. Medication analysis
      if (profile.medicationHistory && profile.medicationHistory.length >= 2) {
        const sortedMeds = [...profile.medicationHistory].sort((a, b) =>
          new Date(a.startDate || 0) - new Date(b.startDate || 0)
        );

        const prevMed = sortedMeds[sortedMeds.length - 2];
        const currentMed = sortedMeds[sortedMeds.length - 1];

        if (prevMed.startDate && currentMed.startDate) {
          const changeDate = new Date(currentMed.startDate);
          const beforeChange = measurements.filter(m => {
            const mDate = new Date(m.ts);
            return mDate < changeDate && mDate > new Date(changeDate - 30 * 24 * 60 * 60 * 1000);
          });
          const afterChange = measurements.filter(m => {
            const mDate = new Date(m.ts);
            return mDate >= changeDate;
          });

          if (beforeChange.length >= 3 && afterChange.length >= 3) {
            const beforeAvg = beforeChange.reduce((sum, m) => sum + m.pef, 0) / beforeChange.length;
            const afterAvg = afterChange.reduce((sum, m) => sum + m.pef, 0) / afterChange.length;
            const change = ((afterAvg - beforeAvg) / beforeAvg) * 100;

            const medName = currentMed.inhaler === 'other' ? currentMed.customName : getInhalerName(currentMed.inhaler);

            if (Math.abs(change) > 5) {
              insights.push({
                icon: change > 0 ? 'üíä' : '‚ö†Ô∏è',
                title: change > 0 ? 'Positiv medicineffekt' : 'Medicinbyte',
                text: change > 0
                  ? `Sedan byte till ${medName} har snittv√§rdet √∂kat med ${Math.round(change)}%.`
                  : `Sedan byte till ${medName} har snittv√§rdet sjunkit ${Math.abs(Math.round(change))}%. F√∂lj upp med din l√§kare.`,
                type: change > 0 ? 'success' : 'warning'
              });
            }
          }
        }
      }

      // 7. Good control
      const allGreen = recent.length >= 5 && recent.every(m => m.zone === 'green');
      if (allGreen) {
        insights.push({
          icon: 'üéâ',
          title: 'Utm√§rkt kontroll',
          text: 'Alla m√§tningar senaste veckan i gr√∂n zon. Forts√§tt s√•!',
          type: 'success'
        });
      }

      // Render insights
      if (insights.length === 0) {
        insights.push({
          icon: 'üìä',
          title: 'Samlar data',
          text: 'Forts√§tt logga f√∂r mer detaljerade insikter.',
          type: 'info'
        });
      }

      container.innerHTML = insights.map(i => `
        <div class="insight-item ${i.type}">
          <div class="insight-icon">${i.icon}</div>
          <div class="insight-content">
            <div class="insight-title">${i.title}</div>
            <div class="insight-text">${i.text}</div>
          </div>
        </div>
      `).join('');
    }

    // Get insights as data (for PDF export)
    function getInsightsData() {
      const insights = [];

      if (measurements.length < 3) {
        return insights;
      }

      const now = Date.now();
      const sevenDaysAgo = now - 7 * 24 * 60 * 60 * 1000;
      const fourteenDaysAgo = now - 14 * 24 * 60 * 60 * 1000;

      const recent = measurements.filter(m => m.ts >= sevenDaysAgo);
      const previous = measurements.filter(m => m.ts >= fourteenDaysAgo && m.ts < sevenDaysAgo);

      // 1. Trend analysis
      if (recent.length >= 3 && previous.length >= 3) {
        const recentAvg = recent.reduce((sum, m) => sum + m.pef, 0) / recent.length;
        const prevAvg = previous.reduce((sum, m) => sum + m.pef, 0) / previous.length;
        const change = ((recentAvg - prevAvg) / prevAvg) * 100;

        if (change <= -10) {
          insights.push({ title: 'Ned√•tg√•ende trend', text: `V√§rden sjunkit ${Math.abs(Math.round(change))}% j√§mf√∂rt med f√∂rra veckan.` });
        } else if (change >= 10) {
          insights.push({ title: 'Upp√•tg√•ende trend', text: `V√§rden √∂kat ${Math.round(change)}% j√§mf√∂rt med f√∂rra veckan.` });
        } else {
          insights.push({ title: 'Stabila v√§rden', text: 'V√§rdena har varit stabila den senaste veckan.' });
        }
      }

      // 2. Variability analysis
      if (recent.length >= 4) {
        const values = recent.map(m => m.pef);
        const max = Math.max(...values);
        const min = Math.min(...values);
        const mean = values.reduce((a, b) => a + b, 0) / values.length;
        const variability = ((max - min) / mean) * 100;

        if (variability > 20) {
          insights.push({ title: 'H√∂g variabilitet', text: `${Math.round(variability)}% variation. >20% kan tyda p√• d√•ligt kontrollerad astma.` });
        } else if (variability > 15) {
          insights.push({ title: 'M√•ttlig variabilitet', text: `${Math.round(variability)}% variation.` });
        } else {
          insights.push({ title: 'L√•g variabilitet', text: `Endast ${Math.round(variability)}% variation - bra kontroll.` });
        }
      }

      // 3. Morning dip analysis
      const morningMeasurements = measurements.filter(m => {
        const hour = new Date(m.ts).getHours();
        return hour >= 5 && hour < 10;
      }).slice(-14);

      const eveningMeasurements = measurements.filter(m => {
        const hour = new Date(m.ts).getHours();
        return hour >= 18 && hour < 23;
      }).slice(-14);

      if (morningMeasurements.length >= 3 && eveningMeasurements.length >= 3) {
        const morningAvg = morningMeasurements.reduce((sum, m) => sum + m.pef, 0) / morningMeasurements.length;
        const eveningAvg = eveningMeasurements.reduce((sum, m) => sum + m.pef, 0) / eveningMeasurements.length;
        if (eveningAvg > 0) {
          const dip = ((eveningAvg - morningAvg) / eveningAvg) * 100;
          if (dip > 15) {
            insights.push({ title: 'Morgondipp', text: `Morgonv√§rden ${Math.round(dip)}% l√§gre √§n kv√§llsv√§rden. Kan tyda p√• nattlig astma.` });
          } else if (dip > 8) {
            insights.push({ title: 'Visst morgondipp', text: `Morgonv√§rden ${Math.round(dip)}% l√§gre √§n kv√§llsv√§rden.` });
          }
        }
      }

      // 4. Red zone warnings
      const recentRed = recent.filter(m => m.zone === 'red');
      if (recentRed.length >= 2) {
        insights.push({ title: 'Varning', text: `${recentRed.length} m√§tningar i r√∂d zon senaste veckan.` });
      }

      // 5. Symptom analysis
      const symptomsRecent = recent.filter(m => m.symptom && m.symptom !== 'frisk');
      const healthyRecent = recent.filter(m => !m.symptom || m.symptom === 'frisk');

      if (symptomsRecent.length >= 2 && healthyRecent.length >= 2) {
        const symptomAvg = symptomsRecent.reduce((sum, m) => sum + m.pef, 0) / symptomsRecent.length;
        const healthyAvg = healthyRecent.reduce((sum, m) => sum + m.pef, 0) / healthyRecent.length;
        if (healthyAvg > 0) {
          const drop = ((healthyAvg - symptomAvg) / healthyAvg) * 100;
          if (drop > 5) {
            insights.push({ title: 'Symptomp√•verkan', text: `Vid symptom sjunker PEF med ca ${Math.round(drop)}%.` });
          }
        }
      }

      // 6. Good control
      const allGreen = recent.length >= 5 && recent.every(m => m.zone === 'green');
      if (allGreen) {
        insights.push({ title: 'Utm√§rkt kontroll', text: 'Alla m√§tningar senaste veckan i gr√∂n zon.' });
      }

      return insights;
    }

    // TensorFlow.js Prediction (Alternativ 2 - aktiveras vid 7+ m√§tningar √∂ver 5+ dagar)
    async function initTensorFlow() {
      if (measurements.length < 7 || isModelTraining || tfModel) return;

      const predContainer = document.getElementById('predictionContainer');
      const aiBadge = document.getElementById('aiBadge');

      try {
        isModelTraining = true;

        // Prepare data
        const daily = dailyBuckets();
        if (daily.length < 5) return;

        // Normalize data
        const values = daily.map(d => d.best);
        const min = Math.min(...values);
        const max = Math.max(...values);
        const range = max - min || 1;
        const normalized = values.map(v => (v - min) / range);

        // Create sequences (use last 3 days to predict next)
        const sequenceLength = Math.min(3, daily.length - 2);
        const xs = [];
        const ys = [];

        for (let i = 0; i < normalized.length - sequenceLength; i++) {
          xs.push(normalized.slice(i, i + sequenceLength));
          ys.push(normalized[i + sequenceLength]);
        }

        if (xs.length < 2) return;

        // Build model
        tfModel = tf.sequential();
        tfModel.add(tf.layers.dense({ units: 16, activation: 'relu', inputShape: [sequenceLength] }));
        tfModel.add(tf.layers.dense({ units: 8, activation: 'relu' }));
        tfModel.add(tf.layers.dense({ units: 1 }));

        tfModel.compile({ optimizer: tf.train.adam(0.01), loss: 'meanSquaredError' });

        // Train
        const xTensor = tf.tensor2d(xs);
        const yTensor = tf.tensor1d(ys);

        await tfModel.fit(xTensor, yTensor, {
          epochs: 50,
          verbose: 0
        });

        xTensor.dispose();
        yTensor.dispose();

        // Predict tomorrow
        const lastSequence = normalized.slice(-sequenceLength);
        const prediction = tfModel.predict(tf.tensor2d([lastSequence]));
        const predValue = prediction.dataSync()[0];
        prediction.dispose();

        // Denormalize
        const predictedPEF = Math.round(predValue * range + min);

        // Calculate confidence based on model stability
        const recentValues = values.slice(-7);
        const recentStd = Math.sqrt(recentValues.reduce((sum, v) => sum + Math.pow(v - recentValues.reduce((a, b) => a + b, 0) / recentValues.length, 2), 0) / recentValues.length);
        const confidence = Math.max(50, Math.min(95, 100 - (recentStd / 10)));

        // Display prediction
        document.getElementById('predictionValue').textContent = `${predictedPEF} L/min`;
        document.getElementById('predictionConfidence').textContent = `Konfidensgrad: ${Math.round(confidence)}% baserat p√• ${daily.length} dagars data`;
        predContainer.style.display = 'block';
        aiBadge.style.display = 'inline-flex';

      } catch (e) {
        console.log('TensorFlow error:', e);
      } finally {
        isModelTraining = false;
      }
    }

    function updateInsights() {
      analyzePatterns();
      initTensorFlow();
    }

    // ============================================
    // Event Listeners
    // ============================================

    document.getElementById('pefInput').addEventListener('input', (e) => {
      updateZoneIndicator(parseInt(e.target.value));
    });

    document.getElementById('pefInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') saveMeasurement();
    });

    document.getElementById('pefInput').addEventListener('focus', (e) => {
      e.target.select();
    });

    ['profileBirthYear', 'profileBirthMonth', 'profileHeight', 'profileAlgorithm'].forEach(id => {
      document.getElementById(id).addEventListener('change', updatePredictedDisplay);
    });

    document.getElementById('profileInhaler').addEventListener('change', updateInhalerStrengths);

    document.getElementById('profileModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) hideProfileModal();
    });

    document.getElementById('editSymptomModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) hideEditSymptomModal();
    });

    // ============================================
    // Init
    // ============================================

    loadData();
    updateUI();
  </script>
</body>
</html>
