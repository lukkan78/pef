<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#6366f1" id="themeColor">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="assets/icon-512.png">
  <title>PEF-dagbok</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #a5b4fc;
      --success: #10b981;
      --success-bg: #d1fae5;
      --warning: #f59e0b;
      --warning-bg: #fef3c7;
      --danger: #ef4444;
      --danger-bg: #fee2e2;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: white;
      --text-primary: var(--gray-800);
      --text-secondary: var(--gray-500);
      --border-color: var(--gray-200);
      --input-bg: white;
      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    }

    /* Dark Mode */
    [data-theme="dark"] {
      --gray-50: #1f2937;
      --gray-100: #374151;
      --gray-200: #4b5563;
      --gray-300: #6b7280;
      --gray-400: #9ca3af;
      --gray-500: #d1d5db;
      --gray-600: #e5e7eb;
      --gray-700: #f3f4f6;
      --gray-800: #f9fafb;
      --gray-900: #ffffff;
      --bg-gradient: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
      --card-bg: #1f2937;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --border-color: #374151;
      --input-bg: #374151;
      --success-bg: rgba(16, 185, 129, 0.2);
      --warning-bg: rgba(245, 158, 11, 0.2);
      --danger-bg: rgba(239, 68, 68, 0.2);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      color: var(--text-primary);
      padding-bottom: 100px;
      transition: background 0.3s;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Header */
    header {
      text-align: center;
      padding: 24px 16px 16px;
      color: white;
      position: relative;
    }

    header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .header-actions {
      position: absolute;
      top: 24px;
      right: 16px;
      display: flex;
      gap: 8px;
    }

    .theme-toggle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.3);
    }

    .theme-toggle svg {
      width: 20px;
      height: 20px;
      color: white;
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-lg);
      transition: background 0.3s;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title .icon {
      width: 20px;
      height: 20px;
      opacity: 0.7;
    }

    /* Input Section */
    .pef-input-wrapper {
      position: relative;
      margin-bottom: 16px;
    }

    .pef-input {
      width: 100%;
      font-size: 48px;
      font-weight: 700;
      text-align: center;
      border: 3px solid var(--border-color);
      border-radius: var(--radius);
      padding: 24px 16px;
      color: var(--text-primary);
      background: var(--input-bg);
      transition: all 0.2s;
      -moz-appearance: textfield;
    }

    .pef-input::-webkit-outer-spin-button,
    .pef-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .pef-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .pef-input::placeholder {
      color: var(--gray-400);
      font-size: 32px;
    }

    .input-suffix {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 16px;
      font-weight: 500;
    }

    /* Zone indicator */
    .zone-indicator {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .zone-bar {
      flex: 1;
      height: 8px;
      border-radius: 4px;
      background: var(--border-color);
      transition: all 0.3s;
    }

    .zone-bar.green { background: var(--success); }
    .zone-bar.yellow { background: var(--warning); }
    .zone-bar.red { background: var(--danger); }
    .zone-bar.inactive { opacity: 0.2; }

    .zone-text {
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
    }

    .zone-text.green { background: var(--success-bg); color: #10b981; }
    .zone-text.yellow { background: var(--warning-bg); color: #f59e0b; }
    .zone-text.red { background: var(--danger-bg); color: #ef4444; }
    .zone-text.neutral { background: var(--gray-100); color: var(--text-secondary); }

    [data-theme="dark"] .zone-text.green { color: #34d399; }
    [data-theme="dark"] .zone-text.yellow { color: #fbbf24; }
    [data-theme="dark"] .zone-text.red { color: #f87171; }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      width: 100%;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 14px;
    }

    .btn-icon {
      width: 40px;
      height: 40px;
      padding: 0;
      border-radius: 50%;
      background: var(--gray-100);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: var(--gray-200);
    }

    .btn-icon svg {
      width: 20px;
      height: 20px;
      color: var(--text-secondary);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-box {
      background: var(--gray-50);
      padding: 16px;
      border-radius: var(--radius-sm);
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .stat-box.highlight {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    }

    .stat-box.highlight .stat-value,
    .stat-box.highlight .stat-label {
      color: white;
    }

    /* Chart */
    .chart-container {
      position: relative;
      height: 200px;
      margin: 16px 0;
    }

    /* History List */
    .history-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      gap: 12px;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-zone {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .history-zone.green { background: var(--success); }
    .history-zone.yellow { background: var(--warning); }
    .history-zone.red { background: var(--danger); }

    .history-content {
      flex: 1;
    }

    .history-value {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary);
    }

    .history-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .history-delete {
      opacity: 0;
      transition: opacity 0.2s;
    }

    .history-item:hover .history-delete {
      opacity: 1;
    }

    /* Profile Form */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-family: inherit;
      transition: all 0.2s;
      background: var(--input-bg);
      color: var(--text-primary);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-input::placeholder {
      color: var(--text-secondary);
    }

    /* Sex selector */
    .sex-selector {
      display: flex;
      gap: 12px;
    }

    .sex-option {
      flex: 1;
      padding: 16px;
      text-align: center;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--input-bg);
      cursor: pointer;
      transition: all 0.2s;
    }

    .sex-option:hover {
      border-color: var(--primary-light);
    }

    .sex-option.active {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
    }

    .sex-option svg {
      width: 32px;
      height: 32px;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .sex-option.active svg {
      color: var(--primary);
    }

    .sex-option span {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 24px;
      width: 100%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s, background 0.3s;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--gray-800);
      color: white;
      padding: 12px 24px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s;
      box-shadow: var(--shadow-lg);
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }

    /* Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      z-index: 100;
      transition: background 0.3s, border-color 0.3s;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 16px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
      border: none;
      background: none;
      cursor: pointer;
      transition: color 0.2s;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-item svg {
      width: 24px;
      height: 24px;
      margin-bottom: 4px;
    }

    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 8px;
    }

    .export-buttons .btn {
      flex: 1;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Reference selector */
    .ref-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .ref-option {
      flex: 1;
      padding: 8px;
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .ref-option.active {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
    }

    /* Profile stats in header */
    .profile-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.2);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      margin-top: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .profile-badge:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .pulse {
      animation: pulse 0.3s ease-in-out;
    }

    /* Responsive */
    @media (max-width: 380px) {
      .pef-input {
        font-size: 40px;
      }
      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .stat-value {
        font-size: 20px;
      }
    }

    /* Install prompt */
    .install-banner {
      background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
      color: white;
      padding: 16px;
      border-radius: var(--radius);
      margin-bottom: 16px;
      display: none;
    }

    .install-banner.show {
      display: block;
    }

    .install-banner h3 {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .install-banner p {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 12px;
    }

    .install-banner .btn {
      background: white;
      color: var(--primary-dark);
    }

    /* Predicted display box */
    .predicted-box {
      background: var(--gray-50);
      padding: 16px;
      border-radius: var(--radius-sm);
      margin-top: 8px;
    }

    .predicted-box .label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .predicted-box .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    /* Profile info display */
    .profile-info {
      background: var(--gray-50);
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .profile-info .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: 600;
    }

    .profile-info .details {
      flex: 1;
    }

    .profile-info .name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .profile-info .meta {
      font-size: 13px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <header>
    <div class="header-actions">
      <button class="theme-toggle" onclick="toggleTheme()" title="Växla mörkt/ljust läge">
        <svg id="themeIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
        </svg>
      </button>
    </div>
    <h1>PEF-dagbok</h1>
    <p>Spåra din lungfunktion</p>
    <div class="profile-badge" onclick="showProfileModal()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
      </svg>
      <span id="profileBadgeText">Ange profil</span>
    </div>
  </header>

  <div class="container">
    <!-- Install Banner -->
    <div class="install-banner" id="installBanner">
      <h3>Installera appen</h3>
      <p>Lägg till PEF-dagbok på din hemskärm för snabb åtkomst och offline-användning.</p>
      <button class="btn" onclick="installApp()">Installera</button>
    </div>

    <!-- Main Sections (controlled by nav) -->
    <main id="mainContent">
      <!-- Logga Section -->
      <section id="sectionLog" class="section active">
        <div class="card">
          <div class="card-header">
            <span class="card-title">
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
              Ny mätning
            </span>
          </div>

          <div class="pef-input-wrapper">
            <input type="number" id="pefInput" class="pef-input" placeholder="---" inputmode="numeric" autocomplete="off">
            <span class="input-suffix">L/min</span>
          </div>

          <div class="zone-indicator">
            <div class="zone-bar green inactive" id="zoneGreen"></div>
            <div class="zone-bar yellow inactive" id="zoneYellow"></div>
            <div class="zone-bar red inactive" id="zoneRed"></div>
          </div>

          <div class="zone-text neutral" id="zoneText">Ange ditt PEF-värde</div>

          <button class="btn btn-primary" id="saveBtn" onclick="saveMeasurement()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Spara mätning
          </button>
        </div>

        <!-- Quick Stats -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Idag</span>
          </div>
          <div class="stats-grid">
            <div class="stat-box highlight">
              <div class="stat-value" id="todayBest">--</div>
              <div class="stat-label">Bästa idag</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="todayCount">0</div>
              <div class="stat-label">Mätningar</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="personalBest">--</div>
              <div class="stat-label">Personbästa</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="predictedValue">--</div>
              <div class="stat-label">Förväntat</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Statistik Section -->
      <section id="sectionStats" class="section" style="display:none">
        <div class="card">
          <div class="card-header">
            <span class="card-title">
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
              </svg>
              Utveckling
            </span>
          </div>

          <div class="ref-selector">
            <button class="ref-option active" data-ref="personal" onclick="setRefMode('personal')">% av personbästa</button>
            <button class="ref-option" data-ref="predicted" onclick="setRefMode('predicted')">% av förväntat</button>
          </div>

          <div class="chart-container">
            <canvas id="pefChart"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Sammanfattning (30 dagar)</span>
          </div>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-value" id="stat30Best">--</div>
              <div class="stat-label">Bästa</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="stat30Avg">--</div>
              <div class="stat-label">Medel</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="stat30Low">--</div>
              <div class="stat-label">Lägsta</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="stat30Count">0</div>
              <div class="stat-label">Mätningar</div>
            </div>
          </div>

          <div class="stats-grid" style="margin-top: 8px;">
            <div class="stat-box" style="background: var(--success-bg);">
              <div class="stat-value" id="statGreen" style="color: var(--success);">0%</div>
              <div class="stat-label" style="color: var(--success);">Grön zon</div>
            </div>
            <div class="stat-box" style="background: var(--warning-bg);">
              <div class="stat-value" id="statYellow" style="color: var(--warning);">0%</div>
              <div class="stat-label" style="color: var(--warning);">Gul zon</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Historik Section -->
      <section id="sectionHistory" class="section" style="display:none">
        <div class="card">
          <div class="card-header">
            <span class="card-title">
              <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Historik
            </span>
            <button class="btn btn-secondary btn-sm" onclick="clearAllData()">Rensa allt</button>
          </div>

          <div class="history-list" id="historyList">
            <div class="empty-state">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              <p>Inga mätningar ännu</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Exportera data</span>
          </div>
          <div class="export-buttons">
            <button class="btn btn-secondary" onclick="exportCSV()">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              CSV
            </button>
            <button class="btn btn-primary" onclick="exportPDF()">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
              </svg>
              PDF-rapport
            </button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-section="sectionLog" onclick="showSection('sectionLog')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
      </svg>
      Logga
    </button>
    <button class="nav-item" data-section="sectionStats" onclick="showSection('sectionStats')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
      </svg>
      Statistik
    </button>
    <button class="nav-item" data-section="sectionHistory" onclick="showSection('sectionHistory')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      Historik
    </button>
  </nav>

  <!-- Profile Modal -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Din profil</h2>
        <button class="btn-icon" onclick="hideProfileModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <div class="form-group">
        <label class="form-label">Namn</label>
        <input type="text" id="profileName" class="form-input" placeholder="Ditt namn">
      </div>

      <div class="form-group">
        <label class="form-label">Kön</label>
        <div class="sex-selector">
          <div class="sex-option" data-sex="male" onclick="selectSex('male')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="10" cy="14" r="5" stroke-width="2"/>
              <path stroke-linecap="round" stroke-width="2" d="M14 10l5-5m0 0v4m0-4h-4"/>
            </svg>
            <span>Man</span>
          </div>
          <div class="sex-option" data-sex="female" onclick="selectSex('female')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="9" r="5" stroke-width="2"/>
              <path stroke-linecap="round" stroke-width="2" d="M12 14v7m-3-3h6"/>
            </svg>
            <span>Kvinna</span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Födelsedatum</label>
        <div class="form-row">
          <div class="form-group">
            <select id="profileBirthYear" class="form-select">
              <option value="">År</option>
            </select>
          </div>
          <div class="form-group">
            <select id="profileBirthMonth" class="form-select">
              <option value="">Månad</option>
              <option value="1">Januari</option>
              <option value="2">Februari</option>
              <option value="3">Mars</option>
              <option value="4">April</option>
              <option value="5">Maj</option>
              <option value="6">Juni</option>
              <option value="7">Juli</option>
              <option value="8">Augusti</option>
              <option value="9">September</option>
              <option value="10">Oktober</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Längd (cm)</label>
        <input type="number" id="profileHeight" class="form-input" placeholder="t.ex. 175" min="100" max="220">
      </div>

      <div class="predicted-box">
        <div class="label">Förväntat PEF-värde</div>
        <div class="value" id="predictedDisplay">-- L/min</div>
      </div>

      <button class="btn btn-primary" onclick="saveProfile()" style="margin-top: 16px;">Spara profil</button>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ============================================
    // Data Management
    // ============================================

    let measurements = [];
    let profile = {
      name: '',
      sex: 'male',
      birthYear: null,
      birthMonth: null,
      heightCm: null,
      predicted: null,
      personalBest: null
    };
    let chart = null;
    let refMode = 'personal';
    let deferredPrompt = null;
    let darkMode = false;

    function loadData() {
      const savedMeas = localStorage.getItem('pef_measurements');
      const savedProfile = localStorage.getItem('pef_profile');
      const savedTheme = localStorage.getItem('pef_theme');

      if (savedMeas) {
        measurements = JSON.parse(savedMeas);
      }

      if (savedProfile) {
        profile = { ...profile, ...JSON.parse(savedProfile) };
      }

      if (savedTheme === 'dark') {
        darkMode = true;
        document.documentElement.setAttribute('data-theme', 'dark');
        updateThemeIcon();
      }

      // Calculate personal best
      if (measurements.length > 0) {
        profile.personalBest = Math.max(...measurements.map(m => m.pef));
      }

      // Calculate predicted if we have profile data
      if (profile.birthYear && profile.heightCm) {
        profile.predicted = calculatePredictedPEF();
      }

      // Populate birth year dropdown
      populateBirthYears();
    }

    function saveData() {
      localStorage.setItem('pef_measurements', JSON.stringify(measurements));
      localStorage.setItem('pef_profile', JSON.stringify(profile));
    }

    function populateBirthYears() {
      const select = document.getElementById('profileBirthYear');
      const currentYear = new Date().getFullYear();
      for (let year = currentYear - 5; year >= currentYear - 100; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        select.appendChild(option);
      }
    }

    // ============================================
    // Theme Toggle
    // ============================================

    function toggleTheme() {
      darkMode = !darkMode;
      if (darkMode) {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('pef_theme', 'dark');
      } else {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('pef_theme', 'light');
      }
      updateThemeIcon();

      // Update chart colors
      if (chart) {
        updateChart();
      }
    }

    function updateThemeIcon() {
      const icon = document.getElementById('themeIcon');
      if (darkMode) {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
      } else {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>';
      }
    }

    // ============================================
    // PEF Prediction (EU Table)
    // ============================================

    const EU_TABLE = {
      female: {
        ages: [20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85],
        heights: [145, 150, 155, 160, 165, 170, 175, 180],
        values: [
          [438, 450, 461, 473, 485, 497, 509, 521],
          [431, 443, 455, 467, 479, 491, 503, 515],
          [423, 435, 447, 459, 471, 483, 495, 507],
          [413, 425, 437, 449, 461, 473, 485, 497],
          [402, 414, 426, 438, 450, 462, 474, 486],
          [390, 402, 414, 426, 438, 450, 462, 474],
          [376, 388, 400, 412, 424, 436, 448, 460],
          [361, 373, 385, 397, 409, 421, 433, 445],
          [345, 357, 369, 381, 393, 405, 417, 429],
          [327, 339, 351, 363, 375, 387, 399, 411],
          [308, 320, 332, 344, 356, 368, 380, 392],
          [288, 300, 312, 324, 336, 348, 360, 372],
          [266, 278, 290, 302, 314, 326, 338, 350],
          [243, 255, 267, 279, 291, 303, 315, 327]
        ]
      },
      male: {
        ages: [20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85],
        heights: [160, 165, 170, 175, 180, 185, 190, 195],
        values: [
          [554, 575, 596, 617, 638, 659, 680, 701],
          [556, 577, 598, 619, 640, 661, 682, 703],
          [556, 577, 598, 619, 640, 661, 682, 703],
          [552, 573, 594, 615, 636, 657, 678, 699],
          [545, 566, 587, 608, 629, 650, 671, 692],
          [535, 556, 577, 598, 619, 640, 661, 682],
          [521, 542, 563, 584, 605, 626, 647, 668],
          [504, 525, 546, 567, 588, 609, 630, 651],
          [484, 505, 526, 547, 568, 589, 610, 631],
          [461, 482, 503, 524, 545, 566, 587, 608],
          [434, 455, 476, 497, 518, 539, 560, 581],
          [404, 425, 446, 467, 488, 509, 530, 551],
          [371, 392, 413, 434, 455, 476, 497, 518],
          [335, 356, 377, 398, 419, 440, 461, 482]
        ]
      }
    };

    function interpolate(x, x0, x1, y0, y1) {
      if (x1 === x0) return y0;
      return y0 + (x - x0) * (y1 - y0) / (x1 - x0);
    }

    function calculateAge(birthYear, birthMonth) {
      const now = new Date();
      let age = now.getFullYear() - birthYear;
      if (birthMonth && now.getMonth() + 1 < birthMonth) {
        age--;
      }
      return age;
    }

    function calculatePredictedPEF(tempProfile = null) {
      const p = tempProfile || profile;
      if (!p.birthYear || !p.heightCm || !p.sex) return null;

      const age = calculateAge(p.birthYear, p.birthMonth);
      const height = p.heightCm;
      const table = EU_TABLE[p.sex];

      if (!table) return null;

      // Clamp values to table range
      const clampedAge = Math.max(table.ages[0], Math.min(table.ages[table.ages.length - 1], age));
      const clampedHeight = Math.max(table.heights[0], Math.min(table.heights[table.heights.length - 1], height));

      // Find surrounding indices for age
      let ageIdx0 = 0, ageIdx1 = 0;
      for (let i = 0; i < table.ages.length - 1; i++) {
        if (clampedAge >= table.ages[i] && clampedAge <= table.ages[i + 1]) {
          ageIdx0 = i;
          ageIdx1 = i + 1;
          break;
        }
      }
      if (clampedAge >= table.ages[table.ages.length - 1]) {
        ageIdx0 = ageIdx1 = table.ages.length - 1;
      }

      // Find surrounding indices for height
      let hIdx0 = 0, hIdx1 = 0;
      for (let i = 0; i < table.heights.length - 1; i++) {
        if (clampedHeight >= table.heights[i] && clampedHeight <= table.heights[i + 1]) {
          hIdx0 = i;
          hIdx1 = i + 1;
          break;
        }
      }
      if (clampedHeight >= table.heights[table.heights.length - 1]) {
        hIdx0 = hIdx1 = table.heights.length - 1;
      }

      // Bilinear interpolation
      const v00 = table.values[ageIdx0][hIdx0];
      const v01 = table.values[ageIdx0][hIdx1];
      const v10 = table.values[ageIdx1][hIdx0];
      const v11 = table.values[ageIdx1][hIdx1];

      const vTop = interpolate(clampedHeight, table.heights[hIdx0], table.heights[hIdx1], v00, v01);
      const vBottom = interpolate(clampedHeight, table.heights[hIdx0], table.heights[hIdx1], v10, v11);
      const result = interpolate(clampedAge, table.ages[ageIdx0], table.ages[ageIdx1], vTop, vBottom);

      return Math.round(result);
    }

    // ============================================
    // Zone Calculation
    // ============================================

    function getZone(pef) {
      const reference = refMode === 'predicted' && profile.predicted
        ? profile.predicted
        : (profile.personalBest || profile.predicted || 500);

      const percentage = (pef / reference) * 100;

      if (percentage >= 80) return 'green';
      if (percentage >= 50) return 'yellow';
      return 'red';
    }

    function getZoneText(zone) {
      switch(zone) {
        case 'green': return 'Grön zon - Bra kontroll';
        case 'yellow': return 'Gul zon - Var uppmärksam';
        case 'red': return 'Röd zon - Agera nu';
        default: return 'Ange ditt PEF-värde';
      }
    }

    function updateZoneIndicator(pef) {
      const zoneGreen = document.getElementById('zoneGreen');
      const zoneYellow = document.getElementById('zoneYellow');
      const zoneRed = document.getElementById('zoneRed');
      const zoneText = document.getElementById('zoneText');

      if (!pef || pef < 60) {
        zoneGreen.classList.add('inactive');
        zoneYellow.classList.add('inactive');
        zoneRed.classList.add('inactive');
        zoneText.className = 'zone-text neutral';
        zoneText.textContent = 'Ange ditt PEF-värde';
        return;
      }

      const zone = getZone(pef);

      zoneGreen.classList.toggle('inactive', zone !== 'green');
      zoneYellow.classList.toggle('inactive', zone !== 'yellow');
      zoneRed.classList.toggle('inactive', zone !== 'red');

      zoneText.className = `zone-text ${zone}`;
      zoneText.textContent = getZoneText(zone);
    }

    // ============================================
    // Measurements
    // ============================================

    function saveMeasurement() {
      const input = document.getElementById('pefInput');
      const value = parseInt(input.value);

      if (!value || value < 60 || value > 900) {
        showToast('Ange ett värde mellan 60-900 L/min', 'error');
        return;
      }

      const zone = getZone(value);
      const measurement = {
        id: Date.now(),
        ts: Date.now(),
        pef: value,
        zone: zone
      };

      measurements.push(measurement);

      // Update personal best
      if (value > (profile.personalBest || 0)) {
        profile.personalBest = value;
      }

      saveData();
      input.value = '';
      updateZoneIndicator(null);
      updateUI();
      showToast('Mätning sparad!', 'success');

      // Animate button
      document.getElementById('saveBtn').classList.add('pulse');
      setTimeout(() => document.getElementById('saveBtn').classList.remove('pulse'), 300);
    }

    function deleteMeasurement(id) {
      if (!confirm('Ta bort denna mätning?')) return;

      measurements = measurements.filter(m => m.id !== id);

      // Recalculate personal best
      profile.personalBest = measurements.length > 0
        ? Math.max(...measurements.map(m => m.pef))
        : null;

      saveData();
      updateUI();
      showToast('Mätning borttagen');
    }

    function clearAllData() {
      if (!confirm('Är du säker på att du vill radera ALL data? Detta kan inte ångras.')) return;

      measurements = [];
      profile.personalBest = null;
      saveData();
      updateUI();
      showToast('All data raderad');
    }

    // ============================================
    // UI Updates
    // ============================================

    function updateUI() {
      updateQuickStats();
      updateHistoryList();
      updateStatistics();
      updateChart();
      updateProfileBadge();
    }

    function updateQuickStats() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const todayMeasurements = measurements.filter(m => {
        const d = new Date(m.ts);
        d.setHours(0, 0, 0, 0);
        return d.getTime() === today.getTime();
      });

      document.getElementById('todayBest').textContent =
        todayMeasurements.length > 0
          ? Math.max(...todayMeasurements.map(m => m.pef))
          : '--';

      document.getElementById('todayCount').textContent = todayMeasurements.length;
      document.getElementById('personalBest').textContent = profile.personalBest || '--';
      document.getElementById('predictedValue').textContent = profile.predicted || '--';
    }

    function updateHistoryList() {
      const list = document.getElementById('historyList');

      if (measurements.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <p>Inga mätningar ännu</p>
          </div>
        `;
        return;
      }

      // Sort by newest first
      const sorted = [...measurements].sort((a, b) => b.ts - a.ts);

      list.innerHTML = sorted.slice(0, 50).map(m => {
        const date = new Date(m.ts);
        const dateStr = date.toLocaleDateString('sv-SE');
        const timeStr = date.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });

        return `
          <div class="history-item">
            <div class="history-zone ${m.zone}"></div>
            <div class="history-content">
              <div class="history-value">${m.pef} L/min</div>
              <div class="history-time">${dateStr} kl ${timeStr}</div>
            </div>
            <button class="btn-icon history-delete" onclick="deleteMeasurement(${m.id})">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        `;
      }).join('');
    }

    function updateStatistics() {
      const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
      const recent = measurements.filter(m => m.ts >= thirtyDaysAgo);

      if (recent.length === 0) {
        document.getElementById('stat30Best').textContent = '--';
        document.getElementById('stat30Avg').textContent = '--';
        document.getElementById('stat30Low').textContent = '--';
        document.getElementById('stat30Count').textContent = '0';
        document.getElementById('statGreen').textContent = '0%';
        document.getElementById('statYellow').textContent = '0%';
        return;
      }

      const values = recent.map(m => m.pef);
      const best = Math.max(...values);
      const low = Math.min(...values);
      const avg = Math.round(values.reduce((a, b) => a + b, 0) / values.length);

      document.getElementById('stat30Best').textContent = best;
      document.getElementById('stat30Avg').textContent = avg;
      document.getElementById('stat30Low').textContent = low;
      document.getElementById('stat30Count').textContent = recent.length;

      // Zone distribution
      const greenCount = recent.filter(m => m.zone === 'green').length;
      const yellowCount = recent.filter(m => m.zone === 'yellow').length;

      document.getElementById('statGreen').textContent = Math.round(100 * greenCount / recent.length) + '%';
      document.getElementById('statYellow').textContent = Math.round(100 * yellowCount / recent.length) + '%';
    }

    function updateProfileBadge() {
      const badge = document.getElementById('profileBadgeText');
      if (profile.name) {
        badge.textContent = profile.name;
      } else if (profile.birthYear && profile.heightCm) {
        const age = calculateAge(profile.birthYear, profile.birthMonth);
        badge.textContent = `${age} år, ${profile.heightCm} cm`;
      } else {
        badge.textContent = 'Ange profil';
      }
    }

    // ============================================
    // Chart
    // ============================================

    function dailyBuckets() {
      const byDay = new Map();

      for (const m of measurements) {
        const d = new Date(m.ts);
        d.setHours(0, 0, 0, 0);
        const key = d.toISOString();

        if (!byDay.has(key)) {
          byDay.set(key, []);
        }
        byDay.get(key).push(m.pef);
      }

      return [...byDay.entries()]
        .map(([iso, arr]) => ({
          day: iso,
          best: Math.max(...arr),
          mean: Math.round(arr.reduce((a, b) => a + b, 0) / arr.length),
          count: arr.length
        }))
        .sort((a, b) => a.day.localeCompare(b.day));
    }

    function rollingAverage(data, days) {
      return data.map((item, idx) => {
        const start = Math.max(0, idx - days + 1);
        const window = data.slice(start, idx + 1);
        const avg = window.reduce((sum, d) => sum + d.best, 0) / window.length;
        return { day: item.day, value: Math.round(avg) };
      });
    }

    function updateChart() {
      const canvas = document.getElementById('pefChart');
      const ctx = canvas.getContext('2d');

      if (chart) {
        chart.destroy();
      }

      const daily = dailyBuckets();

      const textColor = darkMode ? '#e5e7eb' : '#374151';
      const gridColor = darkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';

      if (daily.length === 0) {
        chart = new Chart(ctx, {
          type: 'line',
          data: { labels: [], datasets: [] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: { ticks: { color: textColor } },
              y: { ticks: { color: textColor } }
            }
          }
        });
        return;
      }

      const last30 = daily.slice(-30);
      const r7 = rollingAverage(last30, 7);

      const labels = last30.map(d => {
        const date = new Date(d.day);
        return date.toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' });
      });

      const reference = refMode === 'predicted' && profile.predicted
        ? profile.predicted
        : (profile.personalBest || profile.predicted || 500);

      const greenLine = reference * 0.8;
      const yellowLine = reference * 0.5;
      const maxY = Math.max(...last30.map(d => d.best), reference) * 1.1;

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Bästa/dag',
              data: last30.map(d => d.best),
              borderColor: '#6366f1',
              backgroundColor: darkMode ? 'rgba(99, 102, 241, 0.2)' : 'rgba(99, 102, 241, 0.1)',
              borderWidth: 2,
              pointRadius: 4,
              pointBackgroundColor: '#6366f1',
              tension: 0.3,
              fill: true
            },
            {
              label: '7-dagars medel',
              data: r7.map(d => d.value),
              borderColor: '#f59e0b',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.3,
              borderDash: [5, 5]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          scales: {
            y: {
              min: 0,
              max: maxY,
              grid: { color: gridColor },
              ticks: { color: textColor }
            },
            x: {
              grid: { display: false },
              ticks: { maxTicksLimit: 6, color: textColor }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: { boxWidth: 12, padding: 16, color: textColor }
            },
            tooltip: {
              backgroundColor: darkMode ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.8)',
              titleColor: darkMode ? '#111' : '#fff',
              bodyColor: darkMode ? '#111' : '#fff',
              padding: 12,
              cornerRadius: 8
            }
          }
        },
        plugins: [{
          id: 'zoneBands',
          beforeDraw(chart) {
            const { ctx, chartArea, scales } = chart;
            if (!chartArea) return;

            const y = scales.y;

            ctx.fillStyle = darkMode ? 'rgba(16, 185, 129, 0.15)' : 'rgba(16, 185, 129, 0.1)';
            ctx.fillRect(chartArea.left, y.getPixelForValue(maxY), chartArea.right - chartArea.left, y.getPixelForValue(greenLine) - y.getPixelForValue(maxY));

            ctx.fillStyle = darkMode ? 'rgba(245, 158, 11, 0.15)' : 'rgba(245, 158, 11, 0.1)';
            ctx.fillRect(chartArea.left, y.getPixelForValue(greenLine), chartArea.right - chartArea.left, y.getPixelForValue(yellowLine) - y.getPixelForValue(greenLine));

            ctx.fillStyle = darkMode ? 'rgba(239, 68, 68, 0.15)' : 'rgba(239, 68, 68, 0.1)';
            ctx.fillRect(chartArea.left, y.getPixelForValue(yellowLine), chartArea.right - chartArea.left, y.getPixelForValue(0) - y.getPixelForValue(yellowLine));
          }
        }]
      });
    }

    function setRefMode(mode) {
      refMode = mode;
      document.querySelectorAll('.ref-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.ref === mode);
      });

      measurements = measurements.map(m => ({ ...m, zone: getZone(m.pef) }));
      saveData();

      updateChart();
      updateStatistics();
    }

    // ============================================
    // Profile
    // ============================================

    function selectSex(sex) {
      document.querySelectorAll('.sex-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.sex === sex);
      });
      updatePredictedDisplay();
    }

    function showProfileModal() {
      document.getElementById('profileName').value = profile.name || '';
      document.getElementById('profileBirthYear').value = profile.birthYear || '';
      document.getElementById('profileBirthMonth').value = profile.birthMonth || '';
      document.getElementById('profileHeight').value = profile.heightCm || '';

      document.querySelectorAll('.sex-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.sex === (profile.sex || 'male'));
      });

      updatePredictedDisplay();
      document.getElementById('profileModal').classList.add('active');
    }

    function hideProfileModal() {
      document.getElementById('profileModal').classList.remove('active');
    }

    function updatePredictedDisplay() {
      const sex = document.querySelector('.sex-option.active')?.dataset.sex || 'male';
      const birthYear = parseInt(document.getElementById('profileBirthYear').value);
      const birthMonth = parseInt(document.getElementById('profileBirthMonth').value);
      const height = parseInt(document.getElementById('profileHeight').value);

      if (birthYear && height) {
        const tempProfile = { sex, birthYear, birthMonth, heightCm: height };
        const predicted = calculatePredictedPEF(tempProfile);
        document.getElementById('predictedDisplay').textContent = predicted ? `${predicted} L/min` : '-- L/min';
      } else {
        document.getElementById('predictedDisplay').textContent = '-- L/min';
      }
    }

    function saveProfile() {
      profile.name = document.getElementById('profileName').value.trim();
      profile.sex = document.querySelector('.sex-option.active')?.dataset.sex || 'male';
      profile.birthYear = parseInt(document.getElementById('profileBirthYear').value) || null;
      profile.birthMonth = parseInt(document.getElementById('profileBirthMonth').value) || null;
      profile.heightCm = parseInt(document.getElementById('profileHeight').value) || null;
      profile.predicted = calculatePredictedPEF();

      measurements = measurements.map(m => ({ ...m, zone: getZone(m.pef) }));

      saveData();
      hideProfileModal();
      updateUI();
      showToast('Profil sparad!', 'success');
    }

    // ============================================
    // Export Functions
    // ============================================

    function exportCSV() {
      if (measurements.length === 0) {
        showToast('Inga mätningar att exportera', 'error');
        return;
      }

      const headers = ['Datum', 'Tid', 'PEF (L/min)', 'Zon', '% av referens'];
      const reference = profile.predicted || profile.personalBest || 500;

      const rows = measurements.map(m => {
        const date = new Date(m.ts);
        const pct = Math.round(100 * m.pef / reference);
        return [
          date.toLocaleDateString('sv-SE'),
          date.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' }),
          m.pef,
          m.zone === 'green' ? 'Grön' : m.zone === 'yellow' ? 'Gul' : 'Röd',
          pct + '%'
        ];
      });

      const csv = [headers, ...rows].map(row => row.join(';')).join('\n');
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `pef-export-${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('CSV exporterad!', 'success');
    }

    function exportPDF() {
      if (measurements.length === 0) {
        showToast('Inga mätningar att exportera', 'error');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let y = 20;

      doc.setFontSize(24);
      doc.setFont('helvetica', 'bold');
      doc.text('PEF-rapport', 20, y);
      y += 15;

      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      const firstDate = new Date(Math.min(...measurements.map(m => m.ts)));
      const lastDate = new Date(Math.max(...measurements.map(m => m.ts)));
      doc.text(`Period: ${firstDate.toLocaleDateString('sv-SE')} - ${lastDate.toLocaleDateString('sv-SE')}`, 20, y);
      y += 12;

      if (profile.name) {
        doc.text(`Patient: ${profile.name}`, 20, y);
        y += 8;
      }

      if (profile.birthYear) {
        const age = calculateAge(profile.birthYear, profile.birthMonth);
        doc.text(`${profile.sex === 'female' ? 'Kvinna' : 'Man'}, ${age} år, ${profile.heightCm || '-'} cm`, 20, y);
        y += 8;
      }

      if (profile.predicted) {
        doc.text(`Förväntat PEF: ${profile.predicted} L/min`, 20, y);
        y += 8;
      }

      if (profile.personalBest) {
        doc.text(`Personbästa: ${profile.personalBest} L/min`, 20, y);
        y += 8;
      }

      y += 10;

      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('Sammanfattning', 20, y);
      y += 10;

      const values = measurements.map(m => m.pef);
      const best = Math.max(...values);
      const low = Math.min(...values);
      const avg = Math.round(values.reduce((a, b) => a + b, 0) / values.length);

      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      doc.text(`Antal mätningar: ${measurements.length}`, 20, y); y += 7;
      doc.text(`Högsta värde: ${best} L/min`, 20, y); y += 7;
      doc.text(`Lägsta värde: ${low} L/min`, 20, y); y += 7;
      doc.text(`Medelvärde: ${avg} L/min`, 20, y); y += 7;

      const greenCount = measurements.filter(m => m.zone === 'green').length;
      const yellowCount = measurements.filter(m => m.zone === 'yellow').length;
      const redCount = measurements.filter(m => m.zone === 'red').length;

      doc.text(`Grön zon: ${Math.round(100 * greenCount / measurements.length)}%`, 20, y); y += 7;
      doc.text(`Gul zon: ${Math.round(100 * yellowCount / measurements.length)}%`, 20, y); y += 7;
      doc.text(`Röd zon: ${Math.round(100 * redCount / measurements.length)}%`, 20, y); y += 15;

      const chartCanvas = document.getElementById('pefChart');
      if (chartCanvas) {
        const chartImg = chartCanvas.toDataURL('image/png', 1.0);
        const imgWidth = 170;
        const imgHeight = (chartCanvas.height / chartCanvas.width) * imgWidth;
        doc.addImage(chartImg, 'PNG', 20, y, imgWidth, imgHeight);
        y += imgHeight + 15;
      }

      if (y > 250) {
        doc.addPage();
        y = 20;
      }

      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('Mätningar', 20, y);
      y += 10;

      const tableData = measurements
        .sort((a, b) => b.ts - a.ts)
        .slice(0, 50)
        .map(m => {
          const date = new Date(m.ts);
          const ref = profile.predicted || profile.personalBest || 500;
          const pct = Math.round(100 * m.pef / ref);
          return [
            date.toLocaleDateString('sv-SE'),
            date.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' }),
            `${m.pef} L/min`,
            `${pct}%`,
            m.zone === 'green' ? 'Grön' : m.zone === 'yellow' ? 'Gul' : 'Röd'
          ];
        });

      doc.autoTable({
        startY: y,
        head: [['Datum', 'Tid', 'Värde', '% av ref', 'Zon']],
        body: tableData,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [99, 102, 241] }
      });

      doc.save(`pef-rapport-${new Date().toISOString().slice(0, 10)}.pdf`);
      showToast('PDF-rapport skapad!', 'success');
    }

    // ============================================
    // Navigation
    // ============================================

    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      document.getElementById(sectionId).style.display = 'block';

      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.section === sectionId);
      });

      if (sectionId === 'sectionStats') {
        updateChart();
      }
    }

    // ============================================
    // Toast
    // ============================================

    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ============================================
    // PWA Install
    // ============================================

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installBanner').classList.add('show');
    });

    function installApp() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(() => {
        deferredPrompt = null;
        document.getElementById('installBanner').classList.remove('show');
      });
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(() => {});
    }

    // ============================================
    // Event Listeners
    // ============================================

    document.getElementById('pefInput').addEventListener('input', (e) => {
      updateZoneIndicator(parseInt(e.target.value));
    });

    document.getElementById('pefInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') saveMeasurement();
    });

    document.getElementById('pefInput').addEventListener('focus', (e) => {
      e.target.select();
    });

    ['profileBirthYear', 'profileBirthMonth', 'profileHeight'].forEach(id => {
      document.getElementById(id).addEventListener('change', updatePredictedDisplay);
    });

    document.getElementById('profileModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) hideProfileModal();
    });

    // ============================================
    // Init
    // ============================================

    loadData();
    updateUI();
  </script>
</body>
</html>
